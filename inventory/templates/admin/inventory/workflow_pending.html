{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
  .wf-wrap{padding:12px 10px}
  .wf-top{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:10px}
  .wf-card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:12px 14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .wf-metrics{display:flex;gap:10px;flex-wrap:wrap}
  .wf-metric{min-width:140px}
  .wf-metric .n{font-size:20px;font-weight:800;line-height:1}
  .wf-metric .l{font-size:12px;opacity:.75;margin-top:4px}
  .wf-form label{font-size:12px;opacity:.8;display:block;margin-bottom:4px}
  .wf-form input,.wf-form select{min-width:180px;padding:7px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.15);background:#fff}
  .wf-table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .wf-row{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:12px}
  .wf-row td{padding:10px 12px;vertical-align:top}
  .wf-row:hover{box-shadow:0 2px 8px rgba(0,0,0,.08);cursor:pointer}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .badge-pending{background:rgba(245,158,11,.14);color:#b45309}
  .badge-need{background:rgba(239,68,68,.12);color:#b91c1c}
  .muted{opacity:.75;font-size:12px}
  .wf-links a{margin-right:10px}

  .wf-btn{
    border:1px solid rgba(0,0,0,.12);
    border-radius:10px;
    padding:6px 10px;
    font-weight:700;
    cursor:pointer;
    background:#fff;
    margin-right:6px;
  }
  .wf-approve{ border-color: rgba(34,197,94,.35); }
  .wf-reject{ border-color: rgba(239,68,68,.35); }
  .wf-btn:disabled{ opacity:.55; cursor:not-allowed; }

</style>
{% endblock %}

{% block content %}
<div class="wf-wrap">
  <div class="wf-top">
    <div class="wf-card wf-metrics" style="flex:1 1 420px;">
      <div class="wf-metric">
        <div class="n" id="m_total">{{ rows|length }}</div>
        <div class="l">Нийт pending</div>
      </div>
      <div class="wf-metric">
        <div class="n" id="m_maint">0</div>
        <div class="l">Maintenance</div>
      </div>
      <div class="wf-metric">
        <div class="n" id="m_control">0</div>
        <div class="l">Control</div>
      </div>
      <div class="wf-metric">
        <div class="n" id="m_scope">{% if is_aimag_engineer %}Аймгийн эрх{% else %}Admin{% endif %}</div>
        <div class="l">Хандалтын хүрээ</div>
      </div>
    </div>

    <div class="wf-card wf-form" style="flex:1 1 520px;">
      <div style="font-weight:800;margin-bottom:8px;">Filters</div>
      <form id="wfForm" class="wf-top" style="margin:0;align-items:flex-end;">
        <div>
          <label>Status</label>
          <select name="status" id="f_status">
            <option value="">(pending set)</option>
            {% for s in pending_statuses %}
              <option value="{{ s }}" {% if filters.status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Kind</label>
          <select name="kind" id="f_kind">
            <option value="">ALL</option>
            <option value="MAINT" {% if filters.kind == "MAINT" %}selected{% endif %}>MAINT</option>
            <option value="CONTROL" {% if filters.kind == "CONTROL" %}selected{% endif %}>CONTROL</option>
          </select>
        </div>
        <div>
          <label>Аймаг</label>
          <input name="aimag" id="f_aimag" value="{{ filters.aimag }}" placeholder="код/нэр" {% if is_aimag_engineer %}disabled{% endif %}>
        </div>
        <div>
          <label>Байгууллага</label>
          <input name="org" id="f_org" value="{{ filters.org }}" placeholder="owner_org">
        </div>
        <div>
          <label>Өдөр (days)</label>
          <input name="days" id="f_days" value="{{ filters.days }}" placeholder="7, 30">
        </div>
        <div class="wf-links">
          <a class="button" href="" id="btn_apply">Apply</a>
          <a class="button" href="?" id="btn_reset">Reset</a>
          <a class="button" href="{{ workflow_pending_url }}" target="_blank">Open new tab</a>
        </div>
      </form>
      <div class="muted">⚡ Filters өөрчлөгдөхөд автоматаар шинэчлэгдэнэ (AJAX).</div>
    </div>
  </div>

  <table class="wf-table">
    <thead class="muted">
      <tr>
        <th style="text-align:left;padding:0 12px;">Kind</th>
        <th style="text-align:left;padding:0 12px;">Status</th>
        <th style="text-align:left;padding:0 12px;">Created</th>
        <th style="text-align:left;padding:0 12px;">Device</th>
        <th style="text-align:left;padding:0 12px;">Location</th>
        <th style="text-align:left;padding:0 12px;">Aimag / Org</th>
              <th style="text-align:left;padding:0 12px;width:160px;">Actions</th>
</tr>
    </thead>
    <tbody id="wfBody">
      {% for r in rows %}
      <tr class="wf-row" data-record="{{ r.record_url }}">
        <td><b>{{ r.kind }}</b></td>
        <td>
          {% if r.status == "NEED_APPROVAL" %}
            <span class="badge badge-need">{{ r.status }}</span>
          {% else %}
            <span class="badge badge-pending">{{ r.status }}</span>
          {% endif %}
        </td>
        <td class="muted">{{ r.created_at }}</td>
        <td><a href="{{ r.device_url }}" target="_blank" rel="noopener">{{ r.device_label }}</a></td>
        <td><a href="{{ r.location_url }}" target="_blank" rel="noopener">{{ r.location_label }}</a></td>
        <td class="muted">{{ r.aimag }}<br>{{ r.org }}</td>

        <td>
          <button type="button" class="wf-btn wf-approve" data-kind="{{ r.kind }}" data-id="{{ r.record_id }}">Approve</button>
          <button type="button" class="wf-btn wf-reject" data-kind="{{ r.kind }}" data-id="{{ r.record_id }}">Reject</button>
        </td>

      </tr>
      {% empty %}
      <tr><td class="muted" colspan="7" style="padding:12px;">Pending мөр олдсонгүй.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
(function(){
  const countsUrl = "{{ workflow_pending_counts_url|default:'' }}";
  const ajaxUrl = window.location.pathname; // same page

  
  const reviewUrl = "/django-admin/inventory/workflow/review/";
function setMetrics(rows){
    const total = rows.length;
    const maint = rows.filter(r => r.kind === "MAINT").length;
    const control = rows.filter(r => r.kind === "CONTROL").length;
    document.getElementById("m_total").textContent = total;
    document.getElementById("m_maint").textContent = maint;
    document.getElementById("m_control").textContent = control;
  }

  // row click => open record in new tab
  function bindRowClicks(){
    document.querySelectorAll(".wf-row").forEach(tr=>{
      tr.addEventListener("click", (e)=>{
        const a = e.target.closest("a");
        if(a) return; // normal link click
        const b = e.target.closest("button");
        if(b) return; // button click
        const url = tr.getAttribute("data-record");
        if(url && url !== "#") window.open(url, "_blank", "noopener");
      });
    });
  }

  bindRowClicks();

  function getCSRFToken(){
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }

  async function postReview(kind, id, action, reason){
    const csrf = getCSRFToken();
    const body = new URLSearchParams();
    body.set("kind", kind);
    body.set("id", String(id));
    body.set("action", action);
    if(reason) body.set("reason", reason);

    const res = await fetch(reviewUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
        "X-CSRFToken": csrf,
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
      body: body.toString()
    });

    const data = await res.json().catch(()=> ({}));
    if(!res.ok || !data.ok){
      const msg = data.error || ("Request failed ("+res.status+")");
      throw new Error(msg);
    }
    return data;
  }

  function wireButtons(){
    document.querySelectorAll(".wf-approve, .wf-reject").forEach(btn=>{
      // prevent double-binding
      if(btn.dataset.wired === "1") return;
      btn.dataset.wired = "1";

      btn.addEventListener("click", async (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();

        const kind = btn.getAttribute("data-kind");
        const id = btn.getAttribute("data-id");
        const isReject = btn.classList.contains("wf-reject");

        let reason = "";
        if(isReject){
          reason = prompt("Reject шалтгаан оруулна уу:", "");
          if(reason === null) return;
          reason = (reason || "").trim();
          if(!reason){
            alert("Reject шалтгаан заавал.");
            return;
          }
        }

        const cell = btn.closest("td");
        const buttons = cell ? cell.querySelectorAll("button") : [btn];
        buttons.forEach(b=> b.disabled = true);

        try{
          await postReview(kind, id, isReject ? "reject" : "approve", reason);
          const tr = btn.closest("tr");
          if(tr) tr.remove();
          if(typeof window.refreshPendingCounts === "function"){
            window.refreshPendingCounts();
          }
        }catch(e){
          alert(e.message || "Алдаа гарлаа");
          buttons.forEach(b=> b.disabled = false);
        }
      });
    });
  }

  wireButtons();

  // Initial counts (sidebar/dashboard uses separate endpoint, but we update page metrics too)
  async function fetchCounts(){
    if(!countsUrl) return;
    try{
      const res = await fetch(countsUrl, {credentials:"same-origin"});
      if(!res.ok) return;
      const data = await res.json();
      // optional: could display elsewhere
    }catch(e){}
  }
  fetchCounts();

  const form = document.getElementById("wfForm");
  const inputs = ["f_status","f_kind","f_aimag","f_org","f_days"].map(id=>document.getElementById(id));

  function buildQuery(){
    const params = new URLSearchParams();
    const status = document.getElementById("f_status").value.trim();
    const kind = document.getElementById("f_kind").value.trim();
    const aimag = document.getElementById("f_aimag").value.trim();
    const org = document.getElementById("f_org").value.trim();
    const days = document.getElementById("f_days").value.trim();
    if(status) params.set("status", status);
    if(kind) params.set("kind", kind);
    if(aimag && !document.getElementById("f_aimag").disabled) params.set("aimag", aimag);
    if(org) params.set("org", org);
    if(days) params.set("days", days);
    params.set("ajax","1");
    return params.toString();
  }

  function renderRows(rows){
    const tbody = document.getElementById("wfBody");
    tbody.innerHTML = "";
    if(!rows.length){
      tbody.innerHTML = '<tr><td class="muted" colspan="7" style="padding:12px;">Pending мөр олдсонгүй.</td></tr>';
      return;
    }
    rows.forEach(r=>{
      const badgeClass = (r.status === "NEED_APPROVAL") ? "badge badge-need" : "badge badge-pending";
      const tr = document.createElement("tr");
      tr.className = "wf-row";
      tr.setAttribute("data-record", r.record_url || "#");
      tr.innerHTML = `
        <td><b>${r.kind || ""}</b></td>
        <td><span class="${badgeClass}">${r.status || ""}</span></td>
        <td class="muted">${r.created_at || ""}</td>
        <td><a href="${r.device_url || "#"}" target="_blank" rel="noopener">${r.device_label || "-"}</a></td>
        <td><a href="${r.location_url || "#"}" target="_blank" rel="noopener">${r.location_label || "-"}</a></td>
        <td class="muted">${r.aimag || "-"}<br>${r.org || "-"}</td>
        <td>
          <button type="button" class="wf-btn wf-approve" data-kind="${r.kind || ""}" data-id="${r.record_id}">Approve</button>
          <button type="button" class="wf-btn wf-reject" data-kind="${r.kind || ""}" data-id="${r.record_id}">Reject</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    setMetrics(rows);
    bindRowClicks();
    wireButtons();
  }

  let t=null;
  function scheduleRefresh(){
    if(t) clearTimeout(t);
    t=setTimeout(refresh, 250);
  }

  async function refresh(){
    const qs = buildQuery();
    const url = ajaxUrl + "?" + qs;
    try{
      const res = await fetch(url, {credentials:"same-origin", headers: {"X-Requested-With":"XMLHttpRequest"}});
      if(!res.ok) return;
      const data = await res.json();
      renderRows(data.rows || []);
    }catch(e){}
  }

  inputs.forEach(el=>{
    if(!el) return;
    el.addEventListener("input", scheduleRefresh);
    el.addEventListener("change", scheduleRefresh);
  });

  // Apply button just syncs URL (non-ajax) for sharing
  document.getElementById("btn_apply").addEventListener("click", (e)=>{
    e.preventDefault();
    const params = new URLSearchParams(buildQuery());
    params.delete("ajax");
    window.location.search = params.toString();
  });

  // set initial metric split based on server-rendered rows (best effort)
  const initialRows = Array.from(document.querySelectorAll(".wf-row")).map(tr=>({
    kind: tr.children[0]?.innerText?.trim(),
  }));
  setMetrics(initialRows);
})();
</script>
{% endblock %}
