{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Dashboard Graph{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<style>
    /* =========================================
       1. Django Admin & Jazzmin Layout FIX
       (Sidebar-тай давхцуулахгүйгээр дэлгэц дүүргэх)
       ========================================= */
    
    /* Үндсэн контейнерын өргөний хязгаарлалтыг авах */
    .container, .container-fluid {
        max-width: 100% !important;
        width: 100% !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
    }

    /* Jazzmin-ийн үндсэн content хэсгийг сунгах, 
       гэхдээ margin-г нь 0 болгож БОЛОХГҮЙ (Sidebar-д зай хэрэгтэй) */
    #content-main {
        width: 100% !important;
        max-width: 100% !important;
        float: none !important;
    }

    /* =========================================
       2. Dashboard Custom Styles
       ========================================= */
    .dg-container { 
        padding: 20px; 
        background-color: #f4f6f9; 
        min-height: 100vh; 
        width: 100%;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
    }
    
    .dg-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; /* 50% / 50% багана */
        gap: 20px; 
        margin-top: 20px; 
        width: 100%;
    }

    /* Газрын зургийг доор нь бүтэн уртаар сунгах */
    .full-width { 
        grid-column: 1 / -1; 
    }

    .dg-card { 
        background: #fff; 
        padding: 20px; 
        border-radius: 8px; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        border: 1px solid #e0e0e0;
        width: 100%; 
        box-sizing: border-box; 
    }

    .dg-title { 
        font-weight: bold; 
        font-size: 16px;
        margin-bottom: 15px; 
        border-bottom: 1px solid #eee; 
        padding-bottom: 10px; 
        color: #333;
    }

    .dg-filters { 
        display: flex; 
        gap: 15px; 
        background: #fff; 
        padding: 15px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        align-items: center; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        width: 100%;
        box-sizing: border-box;
    }

    .dg-btn { 
        background: #447e9b; 
        color: white; 
        border: none; 
        padding: 8px 15px; 
        border-radius: 4px; 
        cursor: pointer; 
    }
    .dg-btn:hover { background: #35657b; }
    
    /* Map Legend */
    .map-legend { background: rgba(255,255,255,0.95); padding: 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); font-size: 12px; }
    .legend-row { margin-bottom: 5px; display: flex; align-items: center; cursor: pointer; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; border: 1px solid #666; }
    .pulse-marker { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; stroke-width: 0; } 50% { opacity: 0.5; stroke-width: 10px; } 100% { opacity: 0; stroke-width: 0; } }

    /* Жижиг дэлгэц дээр (Гар утас) автоматаар 1 багана болгох */
    @media (max-width: 1000px) {
        .dg-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dg-container">
    <h1 style="margin-top:0; margin-bottom:20px;">Хянах Самбар (Dashboard)</h1>

    <form class="dg-filters" method="get">
        <label>Огноо:</label>
        <input type="date" name="date_from" value="{{ filter_date_from }}" style="padding: 5px; border:1px solid #ccc; border-radius:4px;"> - 
        <input type="date" name="date_to" value="{{ filter_date_to }}" style="padding: 5px; border:1px solid #ccc; border-radius:4px;">
        
        <select name="status" style="padding: 5px; border:1px solid #ccc; border-radius:4px;">
            <option value="">-- Бүх Төлөв --</option>
            <option value="Active" {% if filter_status == 'Active' %}selected{% endif %}>Active</option>
            <option value="Broken" {% if filter_status == 'Broken' %}selected{% endif %}>Broken</option>
            <option value="Repair" {% if filter_status == 'Repair' %}selected{% endif %}>Repair</option>
            <option value="Stored" {% if filter_status == 'Stored' %}selected{% endif %}>Stored</option>
        </select>

        <button type="submit" class="dg-btn">Шүүх</button>
        <a href="?" class="dg-btn" style="background:#888; text-decoration:none;">Reset</a>
    </form>

    <div class="dg-grid">
        <div class="dg-card">
            <div class="dg-title">Төхөөрөмжийн Төлөв (Timeline)</div>
            <div id="chart_status" style="width: 100%; height: 350px;"></div>
        </div>

        <div class="dg-card">
            <div class="dg-title">Ажлын Урсгал</div>
            <div id="chart_workflow" style="width: 100%; height: 350px;"></div>
        </div>

        <div class="dg-card full-width">
            <div class="dg-title">Байршил</div>
            <div id="map" style="width: 100%; height: 600px;"></div>
        </div>
    </div>
</div>

<script type="application/json" id="data-status">{{ devices_by_status_json|safe }}</script>
<script type="application/json" id="data-workflow">{{ workflow_json|safe }}</script>
<script type="application/json" id="data-locations">{{ locations_json|safe }}</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    function getJson(id) { try { return JSON.parse(document.getElementById(id).textContent); } catch(e){ return []; } }
    
    const statusData = getJson("data-status");
    const wfData = getJson("data-workflow");
    const locData = getJson("data-locations");
    const COLORS = {'Active': '#28a745', 'Broken': '#dc3545', 'Repair': '#ffc107', 'Stored': '#6c757d'};

    // 1. Status Chart (Timeline Line Chart)
    const stEl = document.getElementById("chart_status");
    if(stEl) {
        const chart = echarts.init(stEl);
        const xAxisData = statusData.axis || [];
        const seriesData = statusData.series || {};

        chart.setOption({
            tooltip: { trigger: 'axis' },
            legend: { data: ['Active', 'Broken', 'Repair', 'Stored'], bottom: 0 },
            grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
            xAxis: { 
                type: 'category', 
                data: xAxisData, 
                boundaryGap: false 
            },
            yAxis: { type: 'value' },
            series: [
                {
                    name: 'Active', type: 'line', smooth: true, symbol: 'none',
                    data: seriesData.Active || [], itemStyle: { color: COLORS.Active }, lineStyle: {width: 3}
                },
                {
                    name: 'Broken', type: 'line', smooth: true, symbol: 'none',
                    data: seriesData.Broken || [], itemStyle: { color: COLORS.Broken }, lineStyle: {width: 3}
                },
                {
                    name: 'Repair', type: 'line', smooth: true, symbol: 'none',
                    data: seriesData.Repair || [], itemStyle: { color: COLORS.Repair }, lineStyle: {width: 3}
                },
                {
                    name: 'Stored', type: 'line', smooth: true, symbol: 'none',
                    data: seriesData.Stored || [], itemStyle: { color: COLORS.Stored }, lineStyle: {width: 3}
                }
            ]
        });
        window.addEventListener('resize', ()=>chart.resize());
    }

    // 2. Workflow Chart
    const wfEl = document.getElementById("chart_workflow");
    if(wfEl && wfData.axis) {
        const chart = echarts.init(wfEl);
        chart.setOption({
            tooltip: { trigger: 'axis' },
            legend: { data: ['Maintenance', 'Control'] },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', boundaryGap: false, data: wfData.axis },
            yAxis: { type: 'value' },
            series: [
                { name: 'Maintenance', type: 'line', smooth: true, data: wfData.ms, itemStyle:{color:'#007bff'} },
                { name: 'Control', type: 'line', smooth: true, data: wfData.ca, itemStyle:{color:'#6610f2'} }
            ]
        });
        window.addEventListener('resize', ()=>chart.resize());
    }

    // 3. Map
    const mapEl = document.getElementById("map");
    if(mapEl) {
        const map = L.map('map').setView([47.9, 106.9], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);

        const allMarkers = [];
        locData.forEach(p => {
            if(p.lat != null && p.lon != null) {
                const st = p.status || 'Active';
                const col = COLORS[st] || 'blue';
                const cls = (st==='Broken'||st==='Repair') ? 'pulse-marker' : '';
                
                const m = L.circleMarker([p.lat, p.lon], {
                    radius: 8, fillColor: col, color: '#333', weight: 1, fillOpacity: 0.9, className: cls
                }).bindPopup(`<b>${p.name}</b><br>${st}`);
                
                m.data = {status: st};
                m.addTo(map);
                allMarkers.push(m);
            }
        });

        if(allMarkers.length > 0) {
            const group = L.featureGroup(allMarkers);
            map.fitBounds(group.getBounds(), {padding: [50,50]});
        }

        // Legend
        const legend = L.control({position: 'topright'});
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'map-legend');
            let html = '<strong>Statuses</strong><br>';
            ['Active', 'Broken', 'Repair', 'Stored'].forEach(st => {
                html += `<div class="legend-row">
                    <input type="checkbox" checked class="filter-cb" value="${st}">
                    <span class="legend-dot" style="background:${COLORS[st]}"></span> ${st}
                </div>`;
            });
            div.innerHTML = html;
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        legend.addTo(map);

        document.querySelector('.map-legend').addEventListener('change', function(e) {
            if(e.target.classList.contains('filter-cb')) {
                const checked = Array.from(document.querySelectorAll('.filter-cb:checked')).map(c=>c.value);
                allMarkers.forEach(m => {
                    if(checked.includes(m.data.status)) {
                        if(!map.hasLayer(m)) map.addLayer(m);
                    } else {
                        if(map.hasLayer(m)) map.removeLayer(m);
                    }
                });
            }
        });
    }
});
</script>
{% endblock %}