{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
  .wrap { padding: 14px; }
  .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .cards { display:grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap:10px; margin-top:12px; }
  .card { background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:12px; }
  .k { font-size:12px; opacity:.75; }
  .v { font-size:22px; font-weight:900; margin-top:4px; }
  .grid { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; margin-top:12px; }
  @media (max-width: 1100px){ .grid { grid-template-columns: 1fr; } .cards { grid-template-columns: repeat(2, minmax(140px,1fr)); } }
  .chart { height: 320px; }
  #map { height: 440px; border-radius: 14px; overflow:hidden; border:1px solid rgba(0,0,0,.08); }
  .btn { display:inline-block; padding:8px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.12); background:#fff; text-decoration:none; }
  .btn:hover{ filter: brightness(.98); }
  .muted { font-size:12px; opacity:.75; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  input[type="date"]{ padding:6px 8px; border-radius:10px; border:1px solid rgba(0,0,0,.18); }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="topbar">
    <div>
      <h1 style="margin:0;font-weight:900;">{{ title }}</h1>
      <div class="muted">Chart дээр дарвал admin list filter руу шууд орно.</div>
    </div>

    <form class="row" method="get">
      <span class="muted">Огноо:</span>
      <input type="date" name="date_from" value="{{ date_from|date:'Y-m-d' }}">
      <input type="date" name="date_to" value="{{ date_to|date:'Y-m-d' }}">
      <button class="btn" type="submit">Шүүх</button>

      {% url 'admin:dashboard-export-devices-csv' as csv_url %}
{% url 'admin:dashboard-export-devices-xlsx' as xlsx_url %}

{% if csv_url %}
  <a class="btn" href="{{ csv_url }}?{{ request.GET.urlencode }}">CSV</a>
{% endif %}

{% if xlsx_url %}
  <a class="btn" href="{{ xlsx_url }}?{{ request.GET.urlencode }}">Excel</a>
{% endif %}

    </form>
  </div>

  <div class="cards">
    <div class="card"><div class="k">Байршил</div><div class="v">{{ total_locations }}</div></div>
    <div class="card"><div class="k">Багаж</div><div class="v">{{ total_devices }}</div></div>
    <div class="card"><div class="k">Pending item</div><div class="v">{{ pending_total_items }}</div></div>
    <div class="card"><div class="k">Pending байршил</div><div class="v">{{ pending_locations }}</div></div>
    <div class="card"><div class="k">Эвдрэлтэй байршил</div><div class="v">{{ broken_locations }}</div></div>
    <div class="card"><div class="k">Хоосон байршил</div><div class="v">{{ empty_locations }}</div></div>
  </div>

  <div class="grid">
    <div class="card">
      <div style="font-weight:900;margin-bottom:6px;">Багажийн төлөв (дар → Device list filter)</div>
      <div id="chartStatus" class="chart"></div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:6px;">Workflow SUBMITTED (stacked, огноогоор)</div>
      <div id="chartWorkflow" class="chart"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:900;margin-bottom:6px;">Газрын зураг (Pending/Status)</div>
    <div id="map"></div>
  </div>

</div>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<!-- Leaflet (CDN ok for admin) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // --------------------
  // Data from backend
  // --------------------
  const statusSeries = {{ echarts_status_json|safe }};
  const wf = {{ echarts_workflow_json|safe }};
  const points = {{ locations_json|safe }};

  // --------------------
  // Chart: status
  // --------------------
  const st = echarts.init(document.getElementById("chartStatus"));
  st.setOption({
    tooltip: { trigger: "axis" },
    grid: { left: 40, right: 16, top: 20, bottom: 40 },
    xAxis: { type: "category", data: statusSeries.map(x => x.name), axisLabel:{ rotate: 25 } },
    yAxis: { type: "value" },
    series: [{
      type: "bar",
      data: statusSeries.map(x => ({ value: x.value, url: x.url })),
    }]
  });

  // click -> admin list filter
  st.on("click", (p) => {
    const url = p.data && p.data.url;
    if (url) window.location.href = url;
  });

  // --------------------
  // Chart: workflow stacked
  // --------------------
  const wfChart = echarts.init(document.getElementById("chartWorkflow"));
  wfChart.setOption({
    tooltip: { trigger: "axis" },
    legend: { top: 0 },
    grid: { left: 40, right: 16, top: 28, bottom: 40 },
    xAxis: { type: "category", data: wf.axis, axisLabel:{ rotate: 25 } },
    yAxis: { type: "value" },
    series: [
      { name: "Maintenance", type: "bar", stack: "total", data: wf.ms },
      { name: "Control", type: "bar", stack: "total", data: wf.ca },
    ]
  });

  // --------------------
  // Map
  // --------------------
  const map = L.map("map", { scrollWheelZoom: true }).setView([47.9, 106.9], 5);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
  }).addTo(map);

  function markerColor(p){
    if (Number(p.pending_total || 0) > 0) return "#f59e0b"; // pending orange
    if (p.status === "BROKEN") return "#ef4444";
    if (p.status === "EMPTY") return "#9ca3af";
    return "#22c55e";
  }

  points.forEach(p => {
    const c = markerColor(p);
    const m = L.circleMarker([p.lat, p.lon], {
      radius: 7,
      weight: Number(p.pending_total||0) > 0 ? 3 : 2,
      color: "rgba(0,0,0,.35)",
      fillColor: c,
      fillOpacity: 0.95,
    }).addTo(map);

    const badge = (Number(p.pending_total||0) > 0)
      ? `<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:#f59e0b;color:#111;font-weight:900;font-size:11px">Pending ${p.pending_total}</span>`
      : "";

    const html = `
      <div style="min-width:220px">
        <div style="font-weight:900;font-size:14px;margin-bottom:6px;">${p.name||""}</div>
        <div style="font-size:12px;opacity:.85;line-height:1.45;">
          <div><b>Status:</b> ${p.status||"-"} ${badge}</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          ${p.loc_admin_url ? `<a class="btn" href="${p.loc_admin_url}">Location</a>` : ""}
          ${p.device_list_url ? `<a class="btn" href="${p.device_list_url}">Devices</a>` : ""}
        </div>
      </div>
    `;
    m.bindPopup(html);
  });
</script>
{% endblock %}
