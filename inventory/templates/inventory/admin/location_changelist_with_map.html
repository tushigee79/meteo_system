{% extends "admin/change_list.html" %}
{% load static %}

{# ‚úÖ default search/filters hide #}
{% block search %}{% endblock %}
{% block filters %}{% endblock %}

{% block extrahead %}
  {{ block.super }}

  <!-- Leaflet (local -> CDN fallback) -->
  <link rel="stylesheet"
        href="{% static 'inventory/vendor/leaflet/leaflet.css' %}"
        onerror="this.onerror=null;this.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';">
  <script src="{% static 'inventory/vendor/leaflet/leaflet.js' %}"
          onerror="this.onerror=null;this.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';"></script>

  <!-- MarkerCluster (local -> CDN fallback) -->
  <link rel="stylesheet"
        href="{% static 'inventory/vendor/leaflet.markercluster/MarkerCluster.css' %}"
        onerror="this.onerror=null;this.href='https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css';">
  <link rel="stylesheet"
        href="{% static 'inventory/vendor/leaflet.markercluster/MarkerCluster.Default.css' %}"
        onerror="this.onerror=null;this.href='https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css';">
  <script src="{% static 'inventory/vendor/leaflet.markercluster/leaflet.markercluster.js' %}"
          onerror="this.onerror=null;this.src='https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';"></script>

  <style>
    .content-wrapper, .content, #content, .container-fluid, .container {
      max-width: 100% !important;
      width: 100% !important;
    }

    .locmap-wrap{ width: 100% !important; margin: 10px 0 14px 0; }

    #locmap{
      width: 100% !important;
      height: calc(100vh - 330px);
      min-height: 560px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.12);
      background: #f7f7f7;
      margin-bottom: 10px;
    }

    .locbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin: 8px 0 10px 0;
    }
    .locbar select, .locbar input{
      height: 36px;
      padding: 6px 10px;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background: #fff;
      min-width: 170px;
    }
    .locbar button{
      height: 36px;
      padding: 0 14px;
      border-radius: 6px;
      border: 0;
      background: #1677ff;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    .locbar .small{
      font-size: 12px;
      opacity: .85;
      margin-left: 6px;
    }

    a.button{
      padding: 6px 10px;
      border-radius: 6px;
      background: #1677ff;
      color: #fff !important;
      font-weight: 700;
      text-decoration: none !important;
    }

    /* =========================================================
       ‚úÖ A) Popup card CSS –Ω—ç–º—ç–ª—Ç
       ========================================================= */
    .loc-popup-card{
      min-width: 260px;
      max-width: 320px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
      background: #fff;
    }
    .loc-popup-head{
      padding: 10px 12px;
      background: linear-gradient(135deg, rgba(33,150,243,.12), rgba(156,39,176,.10));
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .loc-popup-title{
      font-weight: 900;
      font-size: 14px;
      margin: 0;
    }
    .loc-popup-sub{
      font-size: 12px;
      opacity: .8;
      margin-top: 2px;
    }
    .loc-popup-body{
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.5;
    }
    .loc-kv{ display:flex; justify-content:space-between; gap:10px; padding:3px 0; }
    .loc-kv b{ font-weight:800; }
    .loc-badges{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .loc-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.04);
      font-weight: 800;
      font-size: 11px;
      text-decoration: none !important;
      color: inherit !important;
    }
    .loc-badge.pending{ background: rgba(243,156,18,.18); border-color: rgba(243,156,18,.35); }
    .loc-actions{
      padding: 10px 12px;
      border-top: 1px solid rgba(0,0,0,.08);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .loc-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 10px;
      text-decoration:none !important;
      border: 1px solid rgba(0,0,0,.14);
      background:#fff;
      font-weight: 800;
      font-size: 12px;
      color: inherit !important;
    }
    .loc-btn.primary{ background: rgba(33,150,243,.12); border-color: rgba(33,150,243,.35); }
    .loc-btn.warn{ background: rgba(243,156,18,.12); border-color: rgba(243,156,18,.35); }
  </style>
{% endblock %}

{% block content %}

  <div class="locmap-wrap">
    <div id="locmap"></div>

    <div class="locbar">
      <select id="f_type"><option value="">–ë–∞–π—Ä—à–ª—ã–Ω —Ç”©—Ä”©–ª</option></select>
      <select id="f_aimag"><option value="">–ê–π–º–∞–≥</option></select>
      <select id="f_sum"><option value="">–°—É–º/–î“Ø“Ø—Ä—ç–≥</option></select>
      <select id="f_org"><option value="">–•–∞—Ä–∏—É—Ü–∞–≥—á</option></select>

      <!-- ‚úÖ Pending only toggle -->
      <label style="display:flex;gap:8px;align-items:center;font-weight:800;margin-left:4px;">
        <input type="checkbox" id="onlyPending">
        –ó”©–≤—Ö”©–Ω Pending
      </label>

      <input id="f_q_local" type="text" placeholder="Map –¥—ç—ç—Ä —Ö–∞–π—Ö..." />
      <button id="btn_apply" type="button">–•–∞–π–ª—Ç (Server)</button>

      <span class="small" id="loc_counts"></span>
    </div>

    <script id="locations-data" type="application/json">{{ locations_json|safe }}</script>
  </div>

  {{ block.super }}

  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      function getParam(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name) || "";
      }
      function setParamBulk(pairs){
        const u = new URL(window.location.href);
        for (const [name,val] of pairs){
          if (!val) u.searchParams.delete(name);
          else u.searchParams.set(name, val);
        }
        u.searchParams.delete("p");
        window.location.href = u.toString();
      }

      /* =========================================================
         ‚úÖ C) escapeHtml() helper (–Ω—ç–≥ —É–¥–∞–∞)
         ========================================================= */
      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      // ---- Parse JSON ----
      let RAW = null;
      try {
        RAW = JSON.parse(($("locations-data").textContent || "[]"));
        if (typeof RAW === "string") RAW = JSON.parse(RAW);
      } catch (e) {
        console.error("locations_json parse error:", e);
        RAW = [];
      }
      const POINTS = Array.isArray(RAW) ? RAW : Object.values(RAW || {});
      $("loc_counts").textContent = `–ù–∏–π—Ç: ${POINTS.length}`;

      if (!window.L) {
        console.error("Leaflet not loaded.");
        return;
      }

      // ---- Map init ----
      const map = L.map("locmap", { zoomControl: true, scrollWheelZoom: true });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      // ‚úÖ Type mapping: DB –¥—ç—ç—Ä ”©”©—Ä –Ω—ç—Ä –∏—Ä—Å—ç–Ω —á —Å—Ç–∞–Ω–¥–∞—Ä—Ç 8 —Ç”©—Ä”©–ª —Ä“Ø“Ø —Ö—É–≤–∏—Ä–≥–∞–Ω–∞
      const TYPE_ALIAS = {
        "METEO":"WEATHER",
        "WEATHER_STATION":"WEATHER",
        "STATION":"WEATHER",
        "CLIMATE":"WEATHER",

        "AUTO":"AWS",
        "AUTOMATIC":"AWS",

        "HYDROLOGY":"HYDRO",

        "AER":"AEROLOGY",
        "UPPERAIR":"AEROLOGY",

        "AGRICULTURE":"AGRO",

        "REFERENCE":"ETALON",
        "CAL":"ETALON",
      };

      const TYPE_COLOR = {
        "WEATHER":"#4b3bff","AWS":"#f2b233","HYDRO":"#1f8f3a","AEROLOGY":"#a000c8",
        "AGRO":"#6a5a2a","ETALON":"#c0392b","RADAR":"#ff3b30","OTHER":"#7f8c8d"
      };

      function normType(t){
        t = (t || "").toString().trim().toUpperCase();
        t = TYPE_ALIAS[t] || t;
        return TYPE_COLOR[t] ? t : "OTHER";
      }

      /* =========================================================
         ‚úÖ Pending highlight icon (divIcon)
         - pending_total > 0 “Ø–µ–¥ —É–ª–±–∞—Ä outline + badge —Ç–æ–æ
         ========================================================= */
      function makeIcon(p){
        const t = normType(p.type);
        const fill = TYPE_COLOR[t] || TYPE_COLOR.OTHER;

        const pt = Number(p.pending_total || 0);
        const pending = pt > 0;

        const outline = pending
          ? "0 0 0 3px rgba(243,156,18,.70)"
          : "0 0 0 2px rgba(0,0,0,.20)";

        const badge = pending
          ? `<div style="
              position:absolute; top:-9px; right:-9px;
              min-width:18px; height:18px; padding:0 5px;
              border-radius:999px; background:#f39c12; color:#fff;
              font-weight:900; font-size:11px;
              display:flex; align-items:center; justify-content:center;
              border:2px solid #fff;
              box-shadow:0 2px 10px rgba(0,0,0,.25);
            ">${pt}</div>`
          : "";

        return L.divIcon({
          className: "loc-pin",
          html: `<div style="position:relative;width:14px;height:14px;">
            <div style="
              width:14px;height:14px;border-radius:50%;
              background:${fill};
              box-shadow:${outline}, 0 6px 16px rgba(0,0,0,.22);
            "></div>
            ${badge}
          </div>`,
          iconSize: [14, 14],
          iconAnchor: [7, 7],
          popupAnchor: [0, -7],
        });
      }

      const hasCluster = !!(L.markerClusterGroup);
      const cluster = hasCluster ? L.markerClusterGroup({ chunkedLoading: true }) : null;

      function uniqBy(arr, keyFn){
        const m = new Map();
        for (const x of arr){
          const k = keyFn(x);
          if (!k) continue;
          if (!m.has(k)) m.set(k, x);
        }
        return Array.from(m.values());
      }
      function fillSelect(sel, items, placeholder){
        sel.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = placeholder;
        sel.appendChild(opt0);
        for (const it of items){
          const o = document.createElement("option");
          o.value = it.id;
          o.textContent = it.name || "-";
          sel.appendChild(o);
        }
      }

      const types = uniqBy(
        POINTS.map(p => ({id:normType(p.type), name:normType(p.type)})),
        x => x.id
      ).sort((a,b)=>a.name.localeCompare(b.name));

      const aimags = uniqBy(
        POINTS.filter(p=>p.aimag_id).map(p => ({id:String(p.aimag_id), name:p.aimag||""})),
        x => x.id
      ).sort((a,b)=>a.name.localeCompare(b.name));

      const orgs = uniqBy(
        POINTS.filter(p=>p.org_id).map(p => ({id:String(p.org_id), name:p.org||""})),
        x => x.id
      ).sort((a,b)=>a.name.localeCompare(b.name));

      fillSelect($("f_type"), types, "–ë–∞–π—Ä—à–ª—ã–Ω —Ç”©—Ä”©–ª");
      fillSelect($("f_aimag"), aimags, "–ê–π–º–∞–≥");
      fillSelect($("f_org"), orgs, "–•–∞—Ä–∏—É—Ü–∞–≥—á");

      function buildSumsForAimag(aimagId){
        const sums = uniqBy(
          POINTS.filter(p => String(p.aimag_id||"") === String(aimagId||"") && p.sum_id)
                .map(p => ({id:String(p.sum_id), name:p.sum||""})),
          x => x.id
        ).sort((a,b)=>a.name.localeCompare(b.name));
        fillSelect($("f_sum"), sums, "–°—É–º/–î“Ø“Ø—Ä—ç–≥");
      }

      // ---- Restore from URL (server-side) ----
      $("f_type").value = getParam("location_type__exact"); // server filter uses raw, but OK for initial UX
      $("f_aimag").value = getParam("aimag_ref__id__exact");
      $("f_org").value = getParam("owner_org__id__exact");
      buildSumsForAimag($("f_aimag").value);
      $("f_sum").value = getParam("sum_ref__id__exact");

      $("f_aimag").addEventListener("change", () => {
        buildSumsForAimag($("f_aimag").value);
        $("f_sum").value = "";
        renderMarkers();
      });

      // ‚úÖ Server-side apply (table + map reload)
      $("btn_apply").addEventListener("click", () => {
        setParamBulk([
          ["location_type__exact", $("f_type").value],
          ["aimag_ref__id__exact", $("f_aimag").value],
          ["sum_ref__id__exact", $("f_sum").value],
          ["owner_org__id__exact", $("f_org").value],
          ["q", ""],
        ]);
      });

      function getAdminUrl(p){
        // ‚úÖ payload –¥–æ—Ç–æ—Ä –±–∞–π–≥–∞–∞ loc_admin_url-–∏–π–≥ –∞—à–∏–≥–ª–∞–Ω–∞ (hardcode –±–∏—à)
        return (p && p.loc_admin_url) ? p.loc_admin_url : null;
      }

      function getDeviceUrl(p){
        // ‚úÖ payload –¥–æ—Ç–æ—Ä –±–∞–π–≥–∞–∞ device_list_url-–∏–π–≥ –∞—à–∏–≥–ª–∞–Ω–∞
        return (p && p.device_list_url) ? p.device_list_url : null;
      }

      let markerLayers = [];

      function renderMarkers(){
        if (cluster) cluster.clearLayers();
        markerLayers.forEach(m => { try { map.removeLayer(m); } catch(e){} });
        markerLayers = [];

        const selOrg = $("f_org").value;
        const selType = $("f_type").value;
        const selAimag = $("f_aimag").value;
        const selSum = $("f_sum").value;
        const qLocal = ($("f_q_local").value || "").trim().toLowerCase();

        // ‚úÖ Pending only toggle
        const onlyPendingEl = $("onlyPending");
        const onlyPending = !!(onlyPendingEl && onlyPendingEl.checked);

        const visibleMarkers = [];
        for (const p of POINTS){
          const lat = Number(p.lat), lon = Number(p.lon);
          if (!isFinite(lat) || !isFinite(lon)) continue;

          // local filters (map only)
          if (selOrg && String(p.org_id||"") !== String(selOrg)) continue;
          if (selType && normType(p.type) !== selType) continue;
          if (selAimag && String(p.aimag_id||"") !== String(selAimag)) continue;
          if (selSum && String(p.sum_id||"") !== String(selSum)) continue;

          if (qLocal){
            const hay = `${p.name||""} ${p.aimag||""} ${p.sum||""} ${p.org||""} ${p.district||""} ${p.wmo||""}`.toLowerCase();
            if (!hay.includes(qLocal)) continue;
          }

          // ‚úÖ pending filter (map only)
          const pm = Number(p.pending_maintenance || 0);
          const pc = Number(p.pending_control || 0);
          const pt = Number(p.pending_total || (pm + pc) || 0);
          if (onlyPending && pt <= 0) continue;

          const m = L.marker([lat, lon], { icon: makeIcon(p), title: p.name || "" });

          /* =========================================================
             ‚úÖ B) PopupHtml-–∏–π–≥ card –±–æ–ª–≥–æ–∂ —Å–æ–ª–∏—Ö
             ========================================================= */
          const locUrl = getAdminUrl(p) || "";
          const devUrl = getDeviceUrl(p) || "";

          const dc = Number(p.device_count || 0);

          const popupHtml = `
            <div class="loc-popup-card">
              <div class="loc-popup-head">
                <div class="loc-popup-title">${escapeHtml(p.name || "")}</div>
                <div class="loc-popup-sub">
                  ${escapeHtml(p.aimag || "-")} ‚Ä¢ ${escapeHtml(p.sum || p.district || "-")}
                </div>
              </div>

              <div class="loc-popup-body">
                <div class="loc-kv"><b>–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞</b><span>${escapeHtml(p.org || "-")}</span></div>
                <div class="loc-kv"><b>–¢”©—Ä”©–ª</b><span>${escapeHtml(p.location_type || p.type || "-")}</span></div>

                <div class="loc-badges">
                  ${devUrl ? `<a class="loc-badge" href="${devUrl}" title="Devices –∂–∞–≥—Å–∞–∞–ª—Ç">${dc} –±–∞–≥–∞–∂</a>` : `<span class="loc-badge">${dc} –±–∞–≥–∞–∂</span>`}
                  ${pt > 0 ? `<span class="loc-badge pending">‚è≥ Pending: ${pt} (MS:${pm}, CA:${pc})</span>` : `<span class="loc-badge">‚úÖ Pending: 0</span>`}
                </div>
              </div>

              <div class="loc-actions">
                ${locUrl ? `<a class="loc-btn primary" href="${locUrl}">üìç Location</a>` : ""}
                ${devUrl ? `<a class="loc-btn warn" href="${devUrl}">üß∞ Devices</a>` : ""}
              </div>
            </div>
          `;

          m.bindPopup(popupHtml);
          m.bindTooltip(p.name || "-", { direction:"top", offset:[0,-8], opacity:0.9 });

          visibleMarkers.push(m);
        }

        if (cluster){
          visibleMarkers.forEach(m => cluster.addLayer(m));
          cluster.addTo(map);
        } else {
          visibleMarkers.forEach(m => { m.addTo(map); markerLayers.push(m); });
        }

        if (visibleMarkers.length){
          const group = L.featureGroup(visibleMarkers);
          map.fitBounds(group.getBounds().pad(0.10));
        } else {
          map.setView([47.9, 106.9], 5);
        }

        $("loc_counts").textContent = `Map: ${visibleMarkers.length} / ${POINTS.length}`;
      }

      ["f_org","f_type","f_sum"].forEach(id => $(id).addEventListener("change", renderMarkers));
      $("f_q_local").addEventListener("input", () => { renderMarkers(); });

      // ‚úÖ pending toggle -> rerender
      const onlyPendingEl = $("onlyPending");
      if (onlyPendingEl) onlyPendingEl.addEventListener("change", renderMarkers);

      renderMarkers();
      setTimeout(() => { try { map.invalidateSize(); } catch(e){} }, 180);
    })();
  </script>
{% endblock %}
