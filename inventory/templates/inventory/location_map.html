{% extends "admin/base_site.html" %}
{% load static %}

{# =========================================================
   Inventory: Location Map (Production Final + Organization filter)
   Template path:
     templates/inventory/location_map.html
   Expects context:
     locations_json (JSON string; list/dict)
   ========================================================= #}

{% block extrahead %}
{{ block.super }}

<link rel="stylesheet" href="{% static 'inventory/vendor/leaflet/leaflet.css' %}">
<script src="{% static 'inventory/vendor/leaflet/leaflet.js' %}"></script>

<link rel="stylesheet" href="{% static 'inventory/vendor/leaflet.markercluster/MarkerCluster.css' %}">
<link rel="stylesheet" href="{% static 'inventory/vendor/leaflet.markercluster/MarkerCluster.Default.css' %}">
<script src="{% static 'inventory/vendor/leaflet.markercluster/leaflet.markercluster.js' %}"></script>

<script src="{% static 'inventory/js/tile_layer_fix.js' %}"></script>

<style>
  .locmap-page { width: 100%; }
  .locmap-page, .locmap-page .container, .locmap-page .container-fluid{
    width: 100% !important; max-width: none !important;
  }

  .locmap-shell{
    height: calc(100vh - 155px);
    min-height: 720px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .locmap-title{
    margin: 0;
    padding: 0;
    font-size: 28px;
    font-weight: 800;
    display:flex;
    align-items:center;
    gap: 10px;
  }

  #locmap{
    flex: 1;
    width: 100%;
    height: 100%;
    min-height: 640px;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,.08);
    background: #f6f7f9;
  }

  .locmap-panel{
    position: absolute;
    left: 14px;
    top: 78px;
    width: 330px;
    max-width: 44vw;
    background: rgba(255,255,255,.96);
    border: 1px solid rgba(0,0,0,.08);
    border-radius: 14px;
    box-shadow: 0 10px 28px rgba(0,0,0,.14);
    padding: 12px;
    z-index: 900;
    backdrop-filter: blur(6px);
  }

  .locmap-panel label{
    display:block;
    font-size: 12px;
    margin: 10px 0 4px;
    opacity: .8;
  }

  .locmap-panel select,
  .locmap-panel input{
    width: 100%;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 10px;
    padding: 8px 10px;
    outline: none;
    background: #fff;
  }

  .locmap-row{ display:flex; gap:10px; }
  .locmap-row > div{ flex: 1; }

  .locmap-btn{
    margin-top: 10px;
    width: 100%;
    border: 0;
    border-radius: 10px;
    padding: 9px 10px;
    cursor: pointer;
    background: #2d6cdf;
    color: #fff;
    font-weight: 700;
  }

  .locmap-muted{ margin-top: 8px; font-size: 12px; opacity: .75; }

  .legend{
    margin-top: 12px;
    border-top: 1px dashed rgba(0,0,0,.15);
    padding-top: 10px;
  }
  .legend-title{ font-weight: 800; font-size: 12px; margin-bottom: 6px; }

  .legend-item{
    display:flex;
    align-items:center;
    gap: 8px;
    font-size: 12px;
    padding: 6px 8px;
    border-radius: 10px;
    cursor: pointer;
    user-select: none;
  }
  .legend-item:hover{ background: rgba(0,0,0,.04); }
  .legend-item.inactive{ opacity: .35; }

  .dot{
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,.15);
    display:inline-block;
    flex: 0 0 10px;
  }

  .leaflet-control-attribution{ font-size: 11px; opacity: .8; }
  .leaflet-popup-content{ margin: 10px 12px; }
  .leaflet-popup-content-wrapper{ border-radius: 12px; }

  @media (max-width: 900px){
    .locmap-shell{ height: calc(100vh - 125px); min-height: 640px; }
    .locmap-panel{
      left: 12px;
      right: 12px;
      width: auto;
      max-width: none;
      top: 66px;
    }
  }


  /* ===== Marker pulse (Pending > 0) ===== */
  .loc-pin .pin-wrap{ position:relative; width:14px; height:14px; }
  .loc-pin .pin-dot{
    width:14px; height:14px; border-radius:50%;
    box-shadow:0 2px 8px rgba(0,0,0,.25);
  }
  .loc-pin .pin-badge{
    position:absolute; top:-8px; right:-8px;
    min-width:18px; height:18px;
    padding:0 5px;
    border-radius:999px;
    background:#f59e0b; color:#fff;
    font-weight:800; font-size:11px;
    display:flex; align-items:center; justify-content:center;
    border:2px solid #fff;
    box-shadow:0 2px 8px rgba(0,0,0,.25);
    line-height:1;
  }
  .loc-pin.pulse .pulse-ring{
    position:absolute;
    left:50%; top:50%;
    width:14px; height:14px;
    transform:translate(-50%,-50%);
    border-radius:999px;
    border:2px solid rgba(245,158,11,.85);
    animation: locPulse 1.35s ease-out infinite;
    pointer-events:none;
  }
  @keyframes locPulse{
    0%   { transform:translate(-50%,-50%) scale(1);   opacity:.85; }
    70%  { transform:translate(-50%,-50%) scale(2.35); opacity:0; }
    100% { transform:translate(-50%,-50%) scale(2.35); opacity:0; }
  }

  /* ===== Popup: Pending badge + links ===== */
  .pending-badge{
    display:inline-flex; align-items:center; justify-content:center;
    min-width:22px; height:18px; padding:0 7px;
    border-radius:999px; font-weight:800; font-size:11px;
    color:#fff; line-height:1;
    vertical-align:middle;
  }
  .pending-badge.is-pending{ background:#f59e0b; }
  .pending-badge.is-zero{ background:#9ca3af; }
  .pending-links a{
    text-decoration:none;
    margin-left:6px;
    padding:2px 7px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.18);
    font-size:11px;
  }
</style>
{% endblock %}

{% block content %}
</div></div></div>  {# close admin content grid wrappers #}

<div class="locmap-shell" style="margin-left:0;">
  <h1 class="locmap-title">üìç –°—Ç–∞–Ω—Ü—É—É–¥—ã–Ω –±–∞–π—Ä—à–∏–ª</h1>

  <div style="position:relative; flex:1;">
    <div id="locmap"></div>

    <script id="locations-data" type="application/json">{{ locations_json|safe }}</script>

      <div class="locmap-panel" id="panel">
        <div class="locmap-row">
          <div>
            <label for="aimagFilter">–ê–π–º–∞–≥</label>
            <select id="aimagFilter">
              <option value="ALL">–ë“Ø–≥–¥</option>
            </select>
          </div>
          <div>
            <label for="typeFilter">–¢”©—Ä”©–ª</label>
            <select id="typeFilter">
              <option value="ALL">–ë“Ø–≥–¥</option>
              <option value="WEATHER">üå¶ –¶–∞–≥ —É—É—Ä</option>
              <option value="AWS">üõ∞ AWS</option>
              <option value="HYDRO">üíß –£—Å —Å—É–¥–ª–∞–ª</option>
              <option value="AEROLOGY">üéà –ê—ç—Ä–æ–ª–æ–≥–∏</option>
              <option value="AGRO">üå± –•–ê–ê/Agro</option>
              <option value="ETALON">üß™ –≠—Ç–∞–ª–æ–Ω</option>
              <option value="RADAR">üì° –†–∞–¥–∞—Ä</option>
              <option value="OTHER">‚öôÔ∏è –ë—É—Å–∞–¥</option>
            </select>
          </div>
        </div>

        <label for="orgFilter">–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞</label>
        <select id="orgFilter">
          <option value="ALL">–ë“Ø–≥–¥</option>
        </select>

        <label for="nameSearch">–°—Ç–∞–Ω—Ü—ã–Ω –Ω—ç—Ä (—Ö–∞–π—Ö)</label>
        <input id="nameSearch" type="text" placeholder="–•–∞–π—Ö..." />

        <button class="locmap-btn" id="clearBtn" type="button">‚Ü∫ –®“Ø“Ø–ª—Ç“Ø“Ø—Ä —Ü—ç–≤—ç—Ä–ª—ç—Ö</button>
        <div class="locmap-muted" id="countLbl">–•–∞—Ä–∞–≥–¥–∞–∂ –±—É–π: 0 / 0</div>

        <div class="legend" id="legendType">
          <div class="legend-title">–°—Ç–∞–Ω—Ü—ã–Ω —Ç”©—Ä”©–ª (toggle)</div>
          <div class="legend-item" data-type="WEATHER"><span class="dot" style="background:#4b3bff;"></span> üå¶ –¶–∞–≥ —É—É—Ä</div>
          <div class="legend-item" data-type="AWS"><span class="dot" style="background:#f2b233;"></span> üõ∞ AWS</div>
          <div class="legend-item" data-type="HYDRO"><span class="dot" style="background:#1f8f3a;"></span> üíß –£—Å —Å—É–¥–ª–∞–ª</div>
          <div class="legend-item" data-type="AEROLOGY"><span class="dot" style="background:#a000c8;"></span> üéà –ê—ç—Ä–æ–ª–æ–≥–∏</div>
          <div class="legend-item" data-type="AGRO"><span class="dot" style="background:#6a5a2a;"></span> üå± –•–ê–ê/Agro</div>
          <div class="legend-item" data-type="ETALON"><span class="dot" style="background:#c0392b;"></span> üß™ –≠—Ç–∞–ª–æ–Ω</div>
          <div class="legend-item" data-type="RADAR"><span class="dot" style="background:#ff3b30;"></span> üì° –†–∞–¥–∞—Ä</div>
          <div class="legend-item" data-type="OTHER"><span class="dot" style="background:#7f8c8d;"></span> ‚öôÔ∏è –ë—É—Å–∞–¥</div>
        </div>

        <div class="legend" id="legendStatus">
          <div class="legend-title">–°—Ç–∞–Ω—Ü—ã–Ω —Ç”©–ª”©–≤ (toggle)</div>
          <div class="legend-item" data-status="OK"><span class="dot" style="background:#2ecc71;"></span> ‚úÖ –•—ç–≤–∏–π–Ω</div>
          <div class="legend-item" data-status="BROKEN"><span class="dot" style="background:#e74c3c;"></span> ‚ö†Ô∏è –≠–≤–¥—Ä—ç–ª—Ç—ç–π</div>
          <div class="legend-item" data-status="EMPTY"><span class="dot" style="background:#95a5a6;"></span> ‚≠ï –ë–∞–≥–∞–∂–≥“Ø–π</div>
        <div class="legend" id="legendPriority">
          <div class="legend-title">–ú–∞—Ä–∫–µ—Ä ”©–Ω–≥”© (priority)</div>
          <div class="legend-item" style="cursor:default;">
            <span class="dot" style="background:#f59e0b;"></span> üü† Pending workflow
          </div>
          <div class="legend-item" style="cursor:default;">
            <span class="dot" style="background:#ef4444;"></span> üî¥ –≠–≤–¥—ç—Ä—Å—ç–Ω
          </div>
          <div class="legend-item" style="cursor:default;">
            <span class="dot" style="background:#9ca3af;"></span> ‚ö™ –ë–∞–≥–∞–∂–≥“Ø–π
          </div>
          <div class="legend-item" style="cursor:default;">
            <span class="dot" style="background:#22c55e;"></span> üü¢ –•—ç–≤–∏–π–Ω
          </div>
        </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  if (typeof window.L === "undefined") {
    console.error("Leaflet (L) is not loaded. Check leaflet.js path.");
    return;
  }

  // ---- Parse JSON ----
  let RAW = null;
  try {
    RAW = JSON.parse(document.getElementById("locations-data").textContent || "[]");
    if (typeof RAW === "string") RAW = JSON.parse(RAW);
  } catch (e) {
    console.error("locations_json parse error:", e);
    RAW = [];
  }
  const POINTS = Array.isArray(RAW) ? RAW : Object.values(RAW || {});
  const totalCount = POINTS.length;

  // ---- Colors ----
  const TYPE_COLORS = {
    WEATHER: "#4b3bff",
    AWS: "#f2b233",
    HYDRO: "#1f8f3a",
    AEROLOGY: "#a000c8",
    AGRO: "#6a5a2a",
    ETALON: "#c0392b",
    RADAR: "#ff3b30",
    OTHER: "#7f8c8d",
  };

  function normType(t){ return (t || "OTHER").toString().toUpperCase(); }
  function normStatus(s){
    const v = (s || "").toString().toUpperCase();
    if (v.includes("BROKEN") || v.includes("–≠–í–î")) return "BROKEN";
    if (v.includes("EMPTY") || v.includes("–ë–ê–ì–ê–ñ–ì“Æ–ô")) return "EMPTY";
    if (v.includes("OK") || v.includes("–•–≠–í")) return "OK";
    return v || "OK";
  }
  function normText(x){
    return (x ?? "").toString().trim();
  }
  function getOrgName(p){
    // Try multiple likely keys (backend might name it differently)
    return normText(
      p.organization_name ?? p.organization ?? p.org_name ?? p.org ??
      p.owner_org ?? p.owner ?? p.har_yalagch ?? p.hariutsagch ?? p.hariutsagch_name ??
      p.responsible_org ?? p.responsible_organization ?? p.bai_guullaga ?? p.bai_guullaga_name
    ) || "–ë—É—Å–∞–¥";
  }
  function getAimagName(p){
    return normText(p.aimag ?? p.aimag_name ?? p.aimagRef ?? p.aimag_ref) || "–ë—É—Å–∞–¥";
  }
  function getTitle(p){
    return normText(p.name ?? p.location_name ?? p.title) || "Unnamed";
  }
  function makeIcon(color, pendingCount, status){
    // status border (legend-—Ç—ç–π –∏–∂–∏–ª)
    const statusBorder =
      status === "BROKEN" ? "#e74c3c" :
      status === "EMPTY"  ? "#95a5a6" :
                            "#2ecc71";

    const hasPending = (pendingCount && pendingCount > 0);

    const badge = hasPending
      ? `<div class="pin-badge">${pendingCount}</div>`
      : "";

    const ring = hasPending ? `<div class="pulse-ring"></div>` : "";

    return L.divIcon({
      className: hasPending ? "loc-pin pulse" : "loc-pin",
      html: `<div class="pin-wrap">
        ${ring}
        <div class="pin-dot" style="background:${color};border:2px solid ${statusBorder};"></div>
        ${badge}
      </div>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7],
      popupAnchor: [0, -7],
    });
  }

  // ---- Map init ----
const map = L.map("locmap", { zoomControl: true });

// Safe tile layer (OSM -> Carto fallback)
if (typeof addSafeTileLayer === "function") {
  addSafeTileLayer(map);
} else {
  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors",
    crossOrigin: true,
  }).addTo(map);
}

function invalidateLater(delay = 50) {
  setTimeout(() => {
    try { map.invalidateSize(true); } catch (e) {}
  }, delay);
}

// —ç—Ö–ª—ç—Ö–¥—ç—ç —Ö—ç–¥ —Ö—ç–¥—ç–Ω —É–¥–∞–∞
invalidateLater(50);
invalidateLater(250);
invalidateLater(900);

// resize “Ø–µ–¥
window.addEventListener("resize", () => invalidateLater(50));

// sidebar/pushmenu toggle –¥–∞—Ä–∞–∞
document.addEventListener("click", (ev) => {
  const t = ev.target;
  const hit =
    t && t.closest &&
    (t.closest("[data-widget='pushmenu']") ||
     t.closest(".sidebar-toggle") ||
     t.closest(".navbar-toggler"));

  if (hit) invalidateLater(300);
});


  const cluster = (L.markerClusterGroup ? L.markerClusterGroup() : L.layerGroup());
  map.addLayer(cluster);

  const markers = [];
  const aimags = new Set();
  const orgs = new Set();

  for (const p of POINTS){
    const lat = Number(p.lat ?? p.latitude ?? p.Lat ?? p.latitude_deg);
    const lng = Number(p.lng ?? p.lon ?? p.longitude ?? p.Lon ?? p.longitude_deg);
    if (!isFinite(lat) || !isFinite(lng)) continue;

    const t = normType(p.location_type || p.type);
    const st = normStatus(p.device_status || p.status);

    const title = getTitle(p);
    const aimag = getAimagName(p);
    const org = getOrgName(p);

    const deviceCount = Number(p.device_count ?? p.deviceCount ?? 0) || 0;
    const pendingMaint = Number(p.pending_maintenance ?? p.pendingMaint ?? 0) || 0;
    const pendingCtrl  = Number(p.pending_control ?? p.pendingCtrl ?? 0) || 0;
    const pendingTotal = Number(p.pending_total ?? (pendingMaint + pendingCtrl) ?? 0) || 0;
    const lastMaint = (p.last_maintenance_date ?? p.lastMaintenanceDate ?? "");
    const lastCtrl  = (p.last_control_date ?? p.lastControlDate ?? "");

    aimags.add(aimag);
    orgs.add(org);

    // --- Marker color priority (pending > broken > empty > ok) ---
    let markerColor = TYPE_COLORS[t] || TYPE_COLORS.OTHER;

    // üî∂ Pending workflow priority
    if (Number(pendingTotal || 0) > 0) {
      markerColor = "#f59e0b"; // orange
    }
    // üî¥ Broken
    else if (st === "BROKEN") {
      markerColor = "#ef4444";
    }
    // ‚ö™ No devices
    else if (st === "EMPTY") {
      markerColor = "#9ca3af";
    }
    // üü¢ OK
    else {
      markerColor = "#22c55e";
    }

    const priorityKey = (pendingTotal > 0) ? "PENDING" : (st === "BROKEN" ? "BROKEN" : (st === "EMPTY" ? "EMPTY" : "OK"));

    const icon = makeIcon(markerColor, pendingTotal, st);
const locUrl = p.loc_admin_url || p.location_url || p.admin_url || p.url || "";
    const devUrl = p.device_list_url || "";

    // Pending lists (Admin changelist links)
    const locId = (p.id ?? p.pk ?? p.location_id ?? p.locationId ?? "");
    const msUrl = locId ? `/admin/inventory/maintenanceservice/?device__location__id__exact=${locId}&workflow_status__exact=SUBMITTED` : "";
    const caUrl = locId ? `/admin/inventory/controladjustment/?device__location__id__exact=${locId}&workflow_status__exact=SUBMITTED` : "";


    const pm = Number(p.pending_maintenance || 0);
    const pc = Number(p.pending_control || 0);
    const pt = Number(p.pending_total || 0);

    const lm = p.last_maintenance_date ? String(p.last_maintenance_date).slice(0,10) : "";
    const lc = p.last_control_date ? String(p.last_control_date).slice(0,10) : "";

    const popupHtml = `
      <div style="min-width:220px;">
        <div style="font-weight:800;font-size:14px;margin-bottom:6px;">${title}</div>
        <div style="font-size:12px;opacity:.85;line-height:1.45;">
          <div><b>–ê–π–º–∞–≥:</b> ${aimag || "-"}</div>
          <div><b>–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞:</b> ${org || "-"}</div>
          <div><b>–¢”©—Ä”©–ª:</b> ${t}</div>
          <div><b>–¢”©–ª”©–≤:</b> ${st}</div>

          <div><b>–ö–æ–æ—Ä–¥:</b> ${lat.toFixed(5)}, ${lng.toFixed(5)}</div>

          <div><b>Pending:</b> <span class="pending-badge ${pt > 0 ? "is-pending" : "is-zero"}">${pt}</span>${(pt > 0 && (msUrl || caUrl)) ? `<span class="pending-links">${msUrl ? `<a href="${msUrl}">MS</a>` : ""}${caUrl ? `<a href="${caUrl}">CA</a>` : ""}</span>` : ""}</div>

          <div style="opacity:.8;"><b>–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π:</b> MS:${pm}, CA:${pc}</div>

          <div><b>–°“Ø“Ø–ª–∏–π–Ω –∑–∞—Å–≤–∞—Ä:</b> ${lm || "-"}</div>

          <div><b>–°“Ø“Ø–ª–∏–π–Ω —Ö—è–Ω–∞–ª—Ç:</b> ${lc || "-"}</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          ${locUrl ? `<a href="${locUrl}" style="text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.15);">Location</a>` : ""}
          ${devUrl ? `<a href="${devUrl}" style="text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.15);">Devices</a>` : ""}
        </div>
      </div>
    `;

    const m = L.marker([lat, lng], { icon, title }).bindPopup(popupHtml);
    cluster.addLayer(m);
    markers.push({ marker: m, data: { ...p, _type:t, _status:st, _title:title, _aimag:aimag, _org:org, _priority: priorityKey } });
  }

  if (markers.length){
    const group = L.featureGroup(markers.map(x => x.marker));
    map.fitBounds(group.getBounds().pad(0.15));
  } else {
    map.setView([46.86, 103.85], 5);
  }

  // ---- Filters ----
  const aimagFilter = document.getElementById("aimagFilter");
  const typeFilter = document.getElementById("typeFilter");
  const orgFilter  = document.getElementById("orgFilter");
  const nameSearch = document.getElementById("nameSearch");
  const countLbl   = document.getElementById("countLbl");
  const clearBtn   = document.getElementById("clearBtn");

  function fillSelect(sel, values){
    const current = sel.value || "ALL";
    while (sel.options.length > 1) sel.remove(1);
    [...values].sort((a,b)=>a.localeCompare(b)).forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });
    if ([...sel.options].some(o=>o.value===current)) sel.value = current;
  }
  fillSelect(aimagFilter, aimags);
  fillSelect(orgFilter, orgs);

  loadQS();
  // ---- Querystring sync (share –ª–∏–Ω–∫) ----
  function loadQS(){
    const p = new URLSearchParams(location.search);
    const a = p.get("aimag"); if (a !== null) aimagFilter.value = a;
    const t = p.get("type");  if (t !== null) typeFilter.value = t;
    const o = p.get("org");   if (o !== null) orgFilter.value = o;
    const q = p.get("q");     if (q !== null) nameSearch.value = q;
  }

  function setQS(){
    const p = new URLSearchParams(location.search);
    p.set("aimag", aimagFilter.value || "");
    p.set("type",  typeFilter.value  || "");
    p.set("org",   orgFilter.value   || "");
    p.set("q",     nameSearch.value  || "");
    history.replaceState(null, "", "?" + p.toString());
  }


  const enabledTypes = new Set(Object.keys(TYPE_COLORS));
  const enabledStatus = new Set(["OK","BROKEN","EMPTY"]);
  const enabledPriority = new Set(["PENDING","BROKEN","EMPTY","OK"]);

  function matchFilters(d){
    const af = aimagFilter.value;
    const tf = typeFilter.value;
    const of = orgFilter.value;
    const q = (nameSearch.value || "").trim().toLowerCase();

    if (af !== "ALL" && (d._aimag || "") !== af) return false;
    if (tf !== "ALL" && d._type !== tf) return false;
    if (of !== "ALL" && (d._org || "") !== of) return false;

    if (!enabledTypes.has(d._type)) return false;
    if (!enabledStatus.has(d._status)) return false;
    if (!enabledPriority.has(d._priority)) return false;

    if (q && !d._title.toLowerCase().includes(q)) return false;
    return true;
  }

  function apply(){
    if (cluster.clearLayers) cluster.clearLayers();
    let shown = 0;
    for (const x of markers){
      if (matchFilters(x.data)){
        cluster.addLayer(x.marker);
        shown += 1;
      }
    }
    countLbl.textContent = `–•–∞—Ä–∞–≥–¥–∞–∂ –±—É–π: ${shown} / ${totalCount}`;
    if (shown > 0){
      const group = L.featureGroup(cluster.getLayers());
      map.fitBounds(group.getBounds().pad(0.15));
    }
    setTimeout(invalidateLater, 50);
    setQS();
  }

  [aimagFilter, typeFilter, orgFilter].forEach(el => el.addEventListener("change", apply));
  nameSearch.addEventListener("input", () => {
    clearTimeout(window.__locmap_t);
    window.__locmap_t = setTimeout(apply, 140);
  });

  clearBtn.addEventListener("click", () => {
    aimagFilter.value = "ALL";
    typeFilter.value = "ALL";
    orgFilter.value = "ALL";
    nameSearch.value = "";

    enabledTypes.clear(); Object.keys(TYPE_COLORS).forEach(t=>enabledTypes.add(t));
    enabledStatus.clear(); ["OK","BROKEN","EMPTY"].forEach(s=>enabledStatus.add(s));

    enabledPriority.clear(); ["PENDING","BROKEN","EMPTY","OK"].forEach(s=>enabledPriority.add(s));

    document.querySelectorAll("#legendType .legend-item").forEach(el=>el.classList.remove("inactive"));
    document.querySelectorAll("#legendStatus .legend-item").forEach(el=>el.classList.remove("inactive"));
    document.querySelectorAll("#legendPriority .legend-item").forEach(el=>el.classList.remove("inactive"));
    apply();
  });

  document.querySelectorAll("#legendType .legend-item").forEach(el => {
    el.addEventListener("click", () => {
      const t = el.getAttribute("data-type");
      if (!t) return;
      if (enabledTypes.has(t)) { enabledTypes.delete(t); el.classList.add("inactive"); }
      else { enabledTypes.add(t); el.classList.remove("inactive"); }
      apply();
    });
  });


  document.querySelectorAll("#legendPriority .legend-item").forEach(el => {
    el.addEventListener("click", () => {
      const pkey = el.getAttribute("data-priority");
      if (!pkey) return;
      if (enabledPriority.has(pkey)) { enabledPriority.delete(pkey); el.classList.add("inactive"); }
      else { enabledPriority.add(pkey); el.classList.remove("inactive"); }
      apply();
    });
  });

  document.querySelectorAll("#legendStatus .legend-item").forEach(el => {
    el.addEventListener("click", () => {
      const s = el.getAttribute("data-status");
      if (!s) return;
      if (enabledStatus.has(s)) { enabledStatus.delete(s); el.classList.add("inactive"); }
      else { enabledStatus.add(s); el.classList.remove("inactive"); }
      apply();
    });
  });

  apply();
})();
</script>
{% endblock %}
