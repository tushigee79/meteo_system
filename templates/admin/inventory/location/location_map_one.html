<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°—Ç–∞–Ω—Ü—É—É–¥—ã–Ω –≥–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { height: 100%; width: 100%; min-height: 520px; background:#eef2f7; }

    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 1000;
      background: rgba(255,255,255,0.96);
      border: 1px solid #e6e6e6; border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.10);
      padding: 10px; width: 320px; max-width: calc(100vw - 30px);
    }
    .panel h3 { margin: 0 0 8px 0; font-size: 14px; font-weight: 700; letter-spacing: .2px; }

    .search-row { display: flex; gap: 8px; }
    .search-row input {
      flex: 1; padding: 9px 10px; border: 1px solid #d9d9d9; border-radius: 10px;
      outline: none; font-size: 14px;
    }
    .search-row button {
      padding: 9px 12px; border: 1px solid #d9d9d9; border-radius: 10px;
      background: #fff; cursor: pointer; font-weight: 600;
    }
    .hint { margin-top: 8px; font-size: 12px; color: #666; line-height: 1.35; }

    /* Legend controls */
    .legend-controls{
      display:flex;
      gap:6px;
      margin-top: 10px;
    }
    .legend-controls button{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #d0d0d0;
      background:#fff;
      cursor:pointer;
      font-weight:600;
    }
    .legend-controls button:hover{ background:#f3f6fb; }

    /* Legend */
    .legend {
      margin-top: 8px;
      display: flex; gap: 10px; flex-wrap: wrap;
      font-size: 12px; color: #444;
      user-select: none;
    }
    .legend-item {
      display: inline-flex; align-items: center;
      cursor: pointer;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid #e6e6e6;
      background: #fff;
      transition: .15s ease;
    }
    .legend-item:hover { box-shadow: 0 4px 14px rgba(0,0,0,0.08); }
    .legend-item.inactive { opacity: 0.35; text-decoration: line-through; filter: grayscale(1); }
    .dot {
      width: 10px; height: 10px; border-radius: 50%;
      display: inline-block; margin-right: 6px;
      border: 2px solid rgba(0,0,0,0.15);
    }

    .results {
      margin-top: 10px; max-height: 260px; overflow: auto;
      border-top: 1px solid #eee; padding-top: 8px;
    }
    .item { padding: 8px 8px; border-radius: 10px; cursor: pointer; }
    .item:hover { background: #f5f7fb; }
    .item .name { font-weight: 700; font-size: 13px; }
    .item .meta { font-size: 12px; color: #666; margin-top: 2px; display: flex; gap: 8px; flex-wrap: wrap; }
    .pill {
      font-size: 11px; padding: 2px 8px; border-radius: 999px;
      border: 1px solid #ddd; background: #fff;
    }

    .mk {
      width: 14px; height: 14px; border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.25);
      box-shadow: 0 2px 10px rgba(0,0,0,0.18);
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <h3>–°—Ç–∞–Ω—Ü —Ö–∞–π—Ö</h3>
    <div class="search-row">
      <input id="q" type="text" placeholder="–ù—ç—Ä / –ê–π–º–∞–≥ / –¢”©—Ä”©–ª”©”©—Ä —Ö–∞–π—Ö‚Ä¶" autocomplete="off">
      <button id="clearBtn" type="button">–¶—ç–≤—ç—Ä–ª—ç—Ö</button>
    </div>
    <div class="hint">Legend –¥—ç—ç—Ä –¥–∞—Ä–∂ —Ç”©—Ä–ª“Ø“Ø–¥–∏–π–≥ ON/OFF —Ö–∏–π–≥—ç—ç–¥, –∂–∞–≥—Å–∞–∞–ª—Ç–∞–∞—Å –¥–∞—Ä–≤–∞–ª —Ü—ç–≥ –¥—ç—ç—Ä –æ—á–æ–æ–¥ –±–∞–≥–∞–∂–∏–π–Ω —Ç–æ–æ –≥–∞—Ä–Ω–∞.</div>

    <div class="legend-controls">
      <button type="button" id="legendOn">–ë“Ø–≥–¥ ON</button>
      <button type="button" id="legendOff">–ë“Ø–≥–¥ OFF</button>
    </div>

    <div class="legend" id="legend" aria-label="legend"></div>

    <div class="results" id="results"></div>
  </div>

  <script id="locations-data" type="application/json">{{ locations_json|safe }}</script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof L === "undefined") {
        console.error("Leaflet –∞—á–∞–∞–ª–∞–≥–¥—Å–∞–Ω–≥“Ø–π.");
        return;
      }

      let DATA = [];
      try {
        const raw = document.getElementById("locations-data").textContent || "[]";
        DATA = JSON.parse(raw);
      } catch (e) {
        console.error("DATA parse error:", e);
        DATA = [];
      }

      const map = L.map("map", { zoomControl: true }).setView([46.8625, 103.8467], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);
      setTimeout(() => map.invalidateSize(), 150);

      const safe = (v) => (v === null || v === undefined ? "" : String(v));

      const typeMeta = {
        WEATHER:  { label: "üå¶ –¶–∞–≥ —É—É—Ä",        color: "#2f80ed" },
        HYDRO:    { label: "üíß –£—Å —Å—É–¥–ª–∞–ª",     color: "#27ae60" },
        AWS:      { label: "üìü AWS",           color: "#f2994a" },
        ETALON:   { label: "üß™ –≠—Ç–∞–ª–æ–Ω",        color: "#9b51e0" },
        RADAR:    { label: "üì° –†–∞–¥–∞—Ä",         color: "#eb5757" },
        AEROLOGY: { label: "üéà –ê—ç—Ä–æ–ª–æ–≥–∏",      color: "#56ccf2" },
        AGRO:     { label: "üå± –•”©–¥”©”© –∞–∂ –∞—Ö—É–π", color: "#6fcf97" },
        OTHER:    { label: "üì¶ –ë—É—Å–∞–¥",         color: "#828282" },
      };

      const activeTypes = Object.fromEntries(Object.keys(typeMeta).map(k => [k, true]));

      function normTypeKey(t) {
        const T = safe(t).trim().toUpperCase();
        if (T === "METEO") return "WEATHER";
        return typeMeta[T] ? T : "OTHER";
      }
      function labelByType(t) { return typeMeta[normTypeKey(t)]?.label || normTypeKey(t); }
      function colorByType(t) { return typeMeta[normTypeKey(t)]?.color || "#999999"; }

      function markerIcon(hex) {
        return L.divIcon({
          className: "",
          html: `<div class="mk" style="background:${hex}"></div>`,
          iconSize: [18, 18],
          iconAnchor: [9, 9],
          popupAnchor: [0, -10],
        });
      }

      function popupHtml(p) {
        return `
          <div style="min-width:200px">
            <div style="font-weight:800; font-size:14px; margin-bottom:6px;">${safe(p.name)}</div>
            <div style="font-size:12px; color:#444; line-height:1.5;">
              <div><b>–ê–π–º–∞–≥:</b> ${safe(p.aimag)}</div>
              <div><b>–¢”©—Ä”©–ª:</b> ${labelByType(p.type)}</div>
              <div><b>–ë–∞–≥–∞–∂–∏–π–Ω —Ç–æ–æ:</b> ${safe(p.device_count ?? 0)}</div>
            </div>
          </div>
        `;
      }

      const markersById = new Map();
      const layer = L.layerGroup().addTo(map);

      function addAllMarkers(list, fit = true) {
        layer.clearLayers();
        markersById.clear();

        const bounds = [];
        list.forEach((p) => {
          if (p.lat == null || p.lon == null) return;

          const mk = L.marker([p.lat, p.lon], { icon: markerIcon(colorByType(p.type)) })
            .bindPopup(popupHtml(p));

          mk.addTo(layer);
          markersById.set(p.id, mk);
          bounds.push([p.lat, p.lon]);
        });

        if (fit && bounds.length > 0) {
          map.fitBounds(bounds, { padding: [40, 40], maxZoom: 12 });
        }
      }

      const q = document.getElementById("q");
      const results = document.getElementById("results");
      const clearBtn = document.getElementById("clearBtn");

      function toKey(p) {
        return `${safe(p.name)} ${safe(p.aimag)} ${safe(p.type)} ${labelByType(p.type)}`.toLowerCase();
      }

      function renderResults(list) {
        results.innerHTML = "";
        if (!list.length) {
          results.innerHTML = `<div style="padding:10px; color:#777; font-size:13px;">“Æ—Ä –¥“Ø–Ω –æ–ª–¥—Å–æ–Ω–≥“Ø–π.</div>`;
          return;
        }

        list.slice(0, 100).forEach((p) => {
          const div = document.createElement("div");
          div.className = "item";

          const tKey = normTypeKey(p.type);
          const tLabel = typeMeta[tKey]?.label || safe(p.type) || "‚Äî";
          const tColor = typeMeta[tKey]?.color || "#999999";

          div.innerHTML = `
            <div class="name">${safe(p.name)}</div>
            <div class="meta">
              <span class="pill">${safe(p.aimag) || "‚Äî"}</span>
              <span class="pill"><span class="dot" style="background:${tColor}; vertical-align:-1px;"></span>${tLabel}</span>
              <span class="pill">–ë–∞–≥–∞–∂: ${safe(p.device_count ?? 0)}</span>
            </div>
          `;

          div.addEventListener("click", () => {
            const mk = markersById.get(p.id);
            if (mk) {
              map.setView(mk.getLatLng(), Math.max(map.getZoom(), 10), { animate: true });
              mk.openPopup();
            }
          });

          results.appendChild(div);
        });
      }

      function applyFilter() {
        const term = (q.value || "").trim().toLowerCase();

        let filtered = DATA.filter((p) => activeTypes[normTypeKey(p.type)]);
        if (term) filtered = filtered.filter((p) => toKey(p).includes(term));

        addAllMarkers(filtered, true);
        renderResults(filtered);
      }

      const legendEl = document.getElementById("legend");

      function buildLegend() {
        if (!legendEl) return;

        legendEl.innerHTML = "";
        Object.keys(typeMeta).forEach((k) => {
          const m = typeMeta[k];
          const el = document.createElement("span");
          el.className = "legend-item" + (activeTypes[k] ? "" : " inactive");
          el.innerHTML = `<span class="dot" style="background:${m.color}"></span>${m.label}`;

          el.addEventListener("click", () => {
            activeTypes[k] = !activeTypes[k];
            buildLegend();
            applyFilter();
          });

          legendEl.appendChild(el);
        });
      }

      const btnOn = document.getElementById("legendOn");
      const btnOff = document.getElementById("legendOff");

      function setAllTypes(state) {
        Object.keys(activeTypes).forEach(k => (activeTypes[k] = state));
        buildLegend();
        applyFilter();
      }

      if (btnOn)  btnOn.addEventListener("click", () => setAllTypes(true));
      if (btnOff) btnOff.addEventListener("click", () => setAllTypes(false));

      buildLegend();
      applyFilter();

      q.addEventListener("input", applyFilter);
      clearBtn.addEventListener("click", () => {
        q.value = "";
        applyFilter();
        q.focus();
      });
    });
  </script>
</body>
</html>
