{% extends "admin/change_list.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #top-map { height: 500px; border-radius: 10px; margin: 14px 0; }
    .leaflet-container { font: inherit; }
  </style>
{% endblock %}

{% block object-tools-items %}
  <li>
    <a class="addlink" style="background-color:#28a745; color:white;"
       href="download-aimag-template/">
      üì• Template —Ç–∞—Ç–∞—Ö
    </a>
  </li>
  {{ block.super }}
{% endblock %}

{% block content %}
  <div id="top-map"></div>

  <script id="locations-data" type="application/json">{{ locations_json|safe }}</script>

  <script>
    (function () {
      const el = document.getElementById("locations-data");
      let DATA = [];
      try { DATA = JSON.parse(el.textContent || "[]"); } catch (e) {}

      const map = L.map("top-map").setView([47.918, 106.917], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      const bounds = [];
      DATA.forEach((x) => {
        if (!x || x.lat == null || x.lon == null) return;
        const m = L.marker([x.lat, x.lon]).addTo(map);
        const title = (x.name || "–ë–∞–π—Ä—à–∏–ª");
        const meta = [
          x.location_type ? ("–¢”©—Ä”©–ª: " + x.location_type) : "",
          x.aimag ? ("–ê–π–º–∞–≥: " + x.aimag) : "",
          x.sum ? ("–°—É–º/–î“Ø“Ø—Ä—ç–≥: " + x.sum) : "",
          x.wmo ? ("WMO: " + x.wmo) : ""
        ].filter(Boolean).join("<br>");
        m.bindPopup("<b>" + title + "</b><br>" + meta);
        bounds.push([x.lat, x.lon]);
      });

      if (bounds.length) map.fitBounds(bounds, { padding: [20, 20] });
    })();
  </script>

  {{ block.super }}
{% endblock %}
