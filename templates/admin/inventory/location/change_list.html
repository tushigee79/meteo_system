{% extends "admin/change_list.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="{% static 'inventory/js/admin/location_changelist_cascade.js' %}"></script>
  <style>
    #top-map { height: 500px; border-radius: 10px; margin: 14px 0; }
    .leaflet-container { font: inherit; }
  </style>
{% endblock %}

{% block object-tools-items %}
  <li>
    <a class="addlink" style="background-color:#28a745; color:white;"
       href="download-aimag-template/">
      üì• Template —Ç–∞—Ç–∞—Ö
    </a>
  </li>
  {{ block.super }}
{% endblock %}

{% block content %}
  <div style="margin: 10px 0 14px 0;">
    <form id="loc-filter-form" method="get" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      {# Preserve search query and other params not in our controls #}
      {% for key, value in request.GET.items %}
        {% if key != "location_type" and key != "aimag" and key != "sum" and key != "owner" and key != "q" %}
          <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endif %}
      {% endfor %}

      {# –ë–∞–π—Ä—à–ª—ã–Ω —Ç”©—Ä”©–ª #}
      <select id="filter_type" name="location_type" style="min-width:180px;">
        <option value="">–ë–∞–π—Ä—à–ª—ã–Ω —Ç”©—Ä”©–ª (–±“Ø–≥–¥)</option>
        {% if LOCATION_TYPE_CHOICES %}
          {% for k,l in LOCATION_TYPE_CHOICES %}
            <option value="{{ k }}" {% if request.GET.location_type == k %}selected{% endif %}>{{ l }}</option>
          {% endfor %}
        {% else %}
          <option value="WEATHER" {% if request.GET.location_type == "WEATHER" %}selected{% endif %}>–¶–∞–≥ —É—É—Ä</option>
          <option value="HYDRO" {% if request.GET.location_type == "HYDRO" %}selected{% endif %}>–£—Å —Å—É–¥–ª–∞–ª</option>
          <option value="AWS" {% if request.GET.location_type == "AWS" %}selected{% endif %}>AWS</option>
          <option value="ETALON" {% if request.GET.location_type == "ETALON" %}selected{% endif %}>–≠—Ç–∞–ª–æ–Ω</option>
          <option value="RADAR" {% if request.GET.location_type == "RADAR" %}selected{% endif %}>–†–∞–¥–∞—Ä</option>
          <option value="AEROLOGY" {% if request.GET.location_type == "AEROLOGY" %}selected{% endif %}>–ê—ç—Ä–æ–ª–æ–≥–∏</option>
          <option value="AGRO" {% if request.GET.location_type == "AGRO" %}selected{% endif %}>–•”©–¥”©”© –∞–∂ –∞—Ö—É–π</option>
          <option value="OTHER" {% if request.GET.location_type == "OTHER" %}selected{% endif %}>–ë—É—Å–∞–¥</option>
        {% endif %}
      </select>

      {# –ê–π–º–∞–≥/–ù–∏–π—Å–ª—ç–ª #}
      {% if aimag_choices %}
        <select id="filter_aimag" name="aimag" style="min-width:180px;">
          <option value="">–ê–π–º–∞–≥/–ù–∏–π—Å–ª—ç–ª (–±“Ø–≥–¥)</option>
          {% for a in aimag_choices %}
            <option value="{{ a.id }}" {% if request.GET.aimag == a.id|stringformat:"s" %}selected{% endif %}>{{ a.name }}</option>
          {% endfor %}
        </select>
      {% else %}
        <select id="filter_aimag" name="aimag" style="min-width:180px;">
          <option value="">–ê–π–º–∞–≥/–ù–∏–π—Å–ª—ç–ª</option>
        </select>
      {% endif %}

      {# –°—É–º/–î“Ø“Ø—Ä—ç–≥ #}
      {% if sum_choices %}
        <select id="filter_sum" name="sum" style="min-width:220px;">
          <option value="">–°—É–º/–î“Ø“Ø—Ä—ç–≥ (–±“Ø–≥–¥)</option>
          {% for s in sum_choices %}
            <option value="{{ s.id }}" {% if request.GET.sum == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
          {% endfor %}
        </select>
      {% else %}
        <select id="filter_sum" name="sum" style="min-width:220px;">
          <option value="">–°—É–º/–î“Ø“Ø—Ä—ç–≥</option>
        </select>
      {% endif %}

      {# –≠–∑—ç–º—à–∏–≥—á –±–∞–π–≥—É—É–ª–ª–∞–≥–∞ (optional) #}
      {% if owner_choices %}
        <select id="filter_owner" name="owner" style="min-width:220px;">
          <option value="">–≠–∑—ç–º—à–∏–≥—á (–±“Ø–≥–¥)</option>
          {% for o in owner_choices %}
            <option value="{{ o.id }}" {% if request.GET.owner == o.id|stringformat:"s" %}selected{% endif %}>{{ o.name }}</option>
          {% endfor %}
        </select>
      {% else %}
        <select id="filter_owner" name="owner" style="min-width:220px;">
          <option value="">–≠–∑—ç–º—à–∏–≥—á</option>
        </select>
      {% endif %}

      <input type="search" name="q" placeholder="–•–∞–π—Ö..." value="{{ request.GET.q|default_if_none:'' }}" style="min-width:220px; padding:6px 8px;">

      <a class="button" href="." style="text-decoration:none;">Reset</a>
    </form>
  </div>

  <div id="top-map"></div>


  <script id="locations-data" type="application/json">{{ locations_json|safe }}</script>

  <script>
    (function () {
      const el = document.getElementById("locations-data");
      let DATA = [];
      try { DATA = JSON.parse(el.textContent || "[]"); } catch (e) {}

      const map = L.map("top-map").setView([47.918, 106.917], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);


      const TYPE_STYLE = {
        WEATHER:  { color: "#1f77b4", label: "–¶–∞–≥ —É—É—Ä" },
        HYDRO:    { color: "#17becf", label: "–£—Å —Å—É–¥–ª–∞–ª" },
        AWS:      { color: "#2ca02c", label: "AWS" },
        ETALON:   { color: "#9467bd", label: "–≠—Ç–∞–ª–æ–Ω" },
        RADAR:    { color: "#d62728", label: "–†–∞–¥–∞—Ä" },
        AEROLOGY: { color: "#ff7f0e", label: "–ê—ç—Ä–æ–ª–æ–≥–∏" },
        AGRO:     { color: "#8c564b", label: "–•”©–¥”©”© –∞–∂ –∞—Ö—É–π" },
        OTHER:    { color: "#7f7f7f", label: "–ë—É—Å–∞–¥" },
      };

      function styleByType(t) {
        const s = TYPE_STYLE[t] || TYPE_STYLE.OTHER;
        return { radius: 6, weight: 2, color: s.color, fillColor: s.color, fillOpacity: 0.9 };
      }

      const bounds = [];
      DATA.forEach((x) => {
        if (!x || x.lat == null || x.lon == null) return;
        const m = L.marker([x.lat, x.lon]).addTo(map);
        const title = (x.name || "–ë–∞–π—Ä—à–∏–ª");
        const meta = [
          x.location_type ? ("–¢”©—Ä”©–ª: " + (TYPE_STYLE[(x.location_type||'').toUpperCase()]?.label || x.location_type)) : "",
          x.aimag ? ("–ê–π–º–∞–≥: " + x.aimag) : "",
          x.sum ? ("–°—É–º/–î“Ø“Ø—Ä—ç–≥: " + x.sum) : "",
          x.wmo ? ("WMO: " + x.wmo) : ""
        ].filter(Boolean).join("<br>");
        m.bindPopup("<b>" + title + "</b><br>" + meta);
        bounds.push([x.lat, x.lon]);
      });

      if (bounds.length) map.fitBounds(bounds, { padding: [20, 20] });
    })();
  </script>

  {{ block.super }}
{% endblock %}
