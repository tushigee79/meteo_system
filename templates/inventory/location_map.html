<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–ë–∞–π—Ä—à–ª—ã–Ω –≥–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background:#f4f7f6; }
        .hdr { padding: 12px 18px; font-weight: 700; background: #2c3e50; color: white; display: flex; align-items: center; gap: 10px; }
        #map { height: calc(100vh - 48px); width: 100%; }

        .ctrl {
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-size: 13px; min-width: 240px;
        }
        .ctrl label { display:block; font-weight: 700; margin-bottom: 5px; color: #34495e; }
        .ctrl select, .ctrl input { 
            width: 100%; margin-bottom: 12px; padding: 8px; 
            border: 1px solid #dcdde1; border-radius: 5px; box-sizing: border-box; 
        }

        .legend {
            background: white; padding: 12px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); line-height: 26px; color: #2f3640;
        }
        .legend b { display: block; margin-bottom: 8px; border-bottom: 1px solid #f1f2f6; padding-bottom: 5px; }
        .legend-item { 
            cursor: pointer; padding: 4px 8px; border-radius: 5px; 
            transition: all 0.2s; display: flex; align-items: center;
        }
        .legend-item:hover { background: #f1f2f6; }
        .legend-item.inactive { opacity: 0.3; text-decoration: line-through; filter: grayscale(1); }
        .dot { 
            height: 12px; width: 12px; border-radius: 50%; 
            display: inline-block; margin-right: 10px; border: 1px solid white;
        }
    </style>
</head>
<body>

<div class="hdr">üì° –°—Ç–∞–Ω—Ü—É—É–¥—ã–Ω –±–∞–π—Ä—à–∏–ª (–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞–∞—Ä —à“Ø“Ø—Ö)</div>
<div id="map"></div>

<script id="locations-data" type="application/json">{{ locations_json|safe }}</script>

<script>
    // 1. –°—É—É—Ä—å —Ç–æ—Ö–∏—Ä–≥–æ–æ
    const map = L.map("map").setView([46.8625, 103.8467], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18 }).addTo(map);

    let points = [];
    try {
        points = JSON.parse(document.getElementById("locations-data").textContent);
    } catch (e) { console.error("Data error:", e); }

    const renderLayer = L.layerGroup().addTo(map);
    let activeTypes = { "METEO": true, "HYDRO": true, "AWS": true };
    const typeColors = { "METEO": "#1f77b4", "HYDRO": "#2ca02c", "AWS": "#ff7f0e" };

    // 2. –®“Ø“Ø–ª—Ç“Ø“Ø—Ä–∏–π–Ω —É–¥–∏—Ä–¥–ª–∞–≥–∞
    const filterCtrl = L.control({position: "topleft"});
    filterCtrl.onAdd = function() {
        const div = L.DomUtil.create("div", "ctrl");
        div.innerHTML = `
            <label>–ê–π–º–∞–≥</label>
            <select id="aimagFilter"><option value="–ë“Ø–≥–¥">–ë“Ø–≥–¥</option></select>
            
            <label>–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞</label>
            <select id="orgFilter">
                <option value="–ë“Ø–≥–¥">–ë“Ø–≥–¥</option>
                <option value="–¶–£–û–®–ì">–¶–£–û–®–ì</option>
                <option value="–ë–û–•–ó–¢–õ">–ë–û–•–ó–¢–õ</option>
                <option value="–ù–¶–£–¢">–ù–¶–£–¢</option>
            </select>
            
            <label>–°—Ç–∞–Ω—Ü—ã–Ω –Ω—ç—Ä</label>
            <input id="nameSearch" placeholder="–•–∞–π—Ö..." />
            <div id="stat" style="font-size:11px; color:#7f8c8d; font-weight:bold; margin-top:5px;"></div>
        `;
        return div;
    };
    filterCtrl.addTo(map);

    // 3. Legend
    const legend = L.control({position: "bottomright"});
    legend.onAdd = function() {
        const div = L.DomUtil.create("div", "legend");
        div.innerHTML = `<b>–°—Ç–∞–Ω—Ü—ã–Ω —Ç”©—Ä”©–ª:</b>`;
        Object.keys(typeColors).forEach(type => {
            const item = L.DomUtil.create("div", "legend-item", div);
            item.innerHTML = `<span class="dot" style="background:${typeColors[type]}"></span>${type}`;
            item.onclick = function() {
                activeTypes[type] = !activeTypes[type];
                this.classList.toggle("inactive");
                render();
            };
        });
        return div;
    };
    legend.addTo(map);

    const aimagSelect = document.getElementById("aimagFilter");
    const orgSelect = document.getElementById("orgFilter");
    const nameSearch = document.getElementById("nameSearch");
    const stat = document.getElementById("stat");

    const aimags = [...new Set(points.map(p => p.aimag))].sort((a, b) => a.localeCompare(b, 'mn'));
    aimags.forEach(a => {
        if(a && a !== "–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π") aimagSelect.innerHTML += `<option value="${a}">${a}</option>`;
    });

    // 4. “Æ–Ω–¥—Å—ç–Ω Render —Ñ—É–Ω–∫—Ü
    function render() {
        const selAimag = aimagSelect.value;
        const selOrg = orgSelect.value;
        const q = (nameSearch.value || "").toLowerCase().trim();

        renderLayer.clearLayers();
        let count = 0;

        points.forEach(p => {
            // "–ê–π–º–∞–≥ –£–¶–£–û–®–¢" –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä “Ø“Ø—Å–≥—ç—Ö –ª–æ–≥–∏–∫
            const autoOrgName = (p.aimag && p.aimag !== "–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π") ? `${p.aimag} –£–¶–£–û–®–¢` : "–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π";
            
            const matchAimag = (selAimag === "–ë“Ø–≥–¥" || p.aimag === selAimag);
            const matchOrg = (selOrg === "–ë“Ø–≥–¥" || p.org === selOrg || autoOrgName === selOrg);
            const matchQuery = (!q || p.name.toLowerCase().includes(q));

            if (activeTypes[p.type] && matchAimag && matchOrg && matchQuery) {
                const color = typeColors[p.type] || "#999999";
                const m = L.circleMarker([p.lat, p.lon], {
                    radius: 8, color: "#fff", weight: 1, fillColor: color, fillOpacity: 0.9
                });
                
                const displayOrg = (p.org && p.org !== "–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π") ? p.org : autoOrgName;
                m.bindPopup(`
                    <div style="min-width:160px;">
                        <b style="font-size:14px; color:#2c3e50;">${p.name}</b><br>
                        <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
                        <b>–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞:</b> ${displayOrg}<br>
                        <b>–ê–π–º–∞–≥:</b> ${p.aimag}<br>
                        <b>üìä –ë–∞–≥–∞–∂–∏–π–Ω —Ç–æ–æ:</b> <span style="color:#e67e22; font-weight:bold;">${p.device_count || 0} —à</span>
                    </div>
                `);
                renderLayer.addLayer(m);
                count++;
            }
        });
        stat.innerHTML = `–•–∞—Ä–∞–≥–¥–∞–∂ –±—É–π: ${count} / ${points.length}`;
    }

    // 5. –®–ò–ù–≠: –ê–π–º–∞–≥ —Å–æ–Ω–≥–æ—Ö–æ–¥ –ë–∞–π–≥—É—É–ª–ª–∞–≥—ã–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä —à“Ø“Ø—Ö –ª–æ–≥–∏–∫
    aimagSelect.onchange = function() {
        const selectedAimag = this.value;
        if (selectedAimag !== "–ë“Ø–≥–¥") {
            const generatedOrg = `${selectedAimag} –£–¶–£–û–®–¢`;
            
            // –•—ç—Ä—ç–≤ –∂–∞–≥—Å–∞–∞–ª—Ç–∞–¥ —Ç—É—Ö–∞–π–Ω –£–¶–£–û–®–¢ –±–∞–π—Ö–≥“Ø–π –±–æ–ª —Ç“Ø—Ä –Ω—ç–º—ç—Ö (—Å–æ–Ω–≥–æ—Ö –±–æ–ª–æ–º–∂—Ç–æ–π –±–æ–ª–≥–æ—Ö)
            let exists = Array.from(orgSelect.options).some(opt => opt.value === generatedOrg);
            if (!exists) {
                const newOpt = new Option(generatedOrg, generatedOrg);
                orgSelect.add(newOpt);
            }
            orgSelect.value = generatedOrg;
        } else {
            orgSelect.value = "–ë“Ø–≥–¥";
        }
        render();
    };

    orgSelect.onchange = render;
    nameSearch.oninput = render;

    // 6. URL-–∞–∞—Å –∏—Ä—Å—ç–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä—ç—ç—Ä –∞–∂–∏–ª–ª–∞—Ö (Zoom 12)
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const targetName = urlParams.get('name');

        if (targetName) {
            nameSearch.value = targetName;
            render(); 

            const targetPoint = points.find(p => p.name.toLowerCase() === targetName.toLowerCase());
            if (targetPoint) {
                map.setView([targetPoint.lat, targetPoint.lon], 12); 
                
                // –ú–∞—Ä–∫–µ—Ä–∏–π–≥ —Ö–∞–π–∂ –æ–ª–æ–æ–¥ –ø–æ–ø-–∞–ø –Ω—ç—ç—Ö
                setTimeout(() => {
                    renderLayer.eachLayer(layer => {
                        if (layer.getLatLng && 
                            layer.getLatLng().lat === targetPoint.lat && 
                            layer.getLatLng().lng === targetPoint.lon) {
                            layer.openPopup();
                        }
                    });
                }, 300); // –î–∞–≤—Ö–∞—Ä–≥—ã–≥ –±“Ø—Ä—ç–Ω –∞—á–∞–∞–ª–∞–≥–¥–∞—Ö—ã–≥ —Ö“Ø–ª—ç—ç—Ö
            }
        } else {
            render(); // –ü–∞—Ä–∞–º–µ—Ç—Ä –±–∞–π—Ö–≥“Ø–π –±–æ–ª —à—É—É–¥ –∑—É—Ä–∞—Ö
        }
    };
</script>

</body>
</html>