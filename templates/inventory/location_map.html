<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="utf-8" />
    <title>–ë–∞–π—Ä—à–ª—ã–Ω –≥–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .ctrl { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.2); min-width: 200px; }
        .ctrl label { display:block; font-weight: bold; margin-top: 8px; }
        .ctrl select, .ctrl input { width: 100%; padding: 6px; margin-top: 4px; }
        .legend { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.2); line-height: 24px; }
        .legend-item { cursor: pointer; display: flex; align-items: center; }
        .legend-item.inactive { opacity: 0.3; text-decoration: line-through; }
        .dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    </style>
</head>
<body>

<div id="map"></div>

<script id="locations-data" type="application/json">{{ locations_json|safe }}</script>

<script>
    function normStr(s) { return (s || "").toString().toLowerCase().trim(); }
    
    const map = L.map("map").setView([46.8625, 103.8467], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const points = JSON.parse(document.getElementById("locations-data").textContent);
    const renderLayer = L.layerGroup().addTo(map);
    
    let activeTypes = { "METEO": true, "HYDRO": true, "AWS": true };
    const typeColors = { "METEO": "#1f77b4", "HYDRO": "#2ca02c", "AWS": "#ff7f0e" };

    // 1. –ó“Ø“Ø–Ω –¥—ç—ç–¥ —à“Ø“Ø–ª—Ç“Ø“Ø—Ä
    const filterCtrl = L.control({position: "topleft"});
    filterCtrl.onAdd = function() {
        const div = L.DomUtil.create("div", "ctrl");
        div.innerHTML = `
            <label>–ê–π–º–∞–≥</label><select id="aimagFilter"><option value="–ë“Ø–≥–¥">–ë“Ø–≥–¥</option></select>
            <label>–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞</label><select id="orgFilter"><option value="–ë“Ø–≥–¥">–ë“Ø–≥–¥</option></select>
            <label>–•–∞–π—Ö</label><input id="nameSearch" placeholder="–°—Ç–∞–Ω—Ü—ã–Ω –Ω—ç—Ä..." />
            <div id="stat" style="margin-top:10px; font-size:12px;"></div>
        `;
        return div;
    };
    filterCtrl.addTo(map);

    // 2. –ë–∞—Ä—É—É–Ω –¥–æ–æ–¥ –∏–¥—ç–≤—Ö—Ç—ç–π Legend
    const legend = L.control({position: "bottomright"});
    legend.onAdd = function() {
        const div = L.DomUtil.create("div", "legend");
        div.innerHTML = `<b>–¢”©—Ä–ª”©”©—Ä —à“Ø“Ø—Ö:</b><br>`;
        Object.keys(typeColors).forEach(type => {
            const item = L.DomUtil.create("div", "legend-item", div);
            item.innerHTML = `<span class="dot" style="background:${typeColors[type]}"></span>${type}`;
            item.onclick = function() {
                activeTypes[type] = !activeTypes[type];
                this.classList.toggle("inactive");
                render();
            };
        });
        return div;
    };
    legend.addTo(map);

    const aimagSelect = document.getElementById("aimagFilter");
    const orgSelect = document.getElementById("orgFilter");
    const nameSearch = document.getElementById("nameSearch");

    // –°–æ–Ω–≥–æ–ª—Ç—É—É–¥—ã–≥ –±”©–≥–ª”©—Ö
    const aimags = [...new Set(points.map(p => p.aimag))].sort();
    aimags.forEach(a => aimagSelect.innerHTML += `<option value="${a}">${a}</option>`);
    
    const orgs = [...new Set(points.map(p => p.org))].sort();
    orgs.forEach(o => orgSelect.innerHTML += `<option value="${o}">${o}</option>`);

    function createMarker(p) {
        const marker = L.circleMarker([p.lat, p.lon], {
            radius: 8, color: "#fff", weight: 1, fillColor: typeColors[p.type], fillOpacity: 0.9
        });
        marker.bindPopup(`<b>${p.name}</b><br>–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞: ${p.org}<br>üìä –ë–∞–≥–∞–∂: ${p.device_count} —à`);
        marker.__data = p;
        return marker;
    }

    const markers = points.map(p => createMarker(p));

    function render() {
        const a = aimagSelect.value;
        const o = orgSelect.value;
        const q = normStr(nameSearch.value);
        const urlParams = new URLSearchParams(window.location.search);
        const target = normStr(urlParams.get('name'));

        renderLayer.clearLayers();
        let count = 0;

        markers.forEach(m => {
            const d = m.__data;
            const isTarget = target && normStr(d.name) === target;
            const match = (a === "–ë“Ø–≥–¥" || d.aimag === a) && 
                          (o === "–ë“Ø–≥–¥" || d.org === o) && 
                          (!q || normStr(d.name).includes(q));

            if (isTarget || (activeTypes[d.type] && match)) {
                renderLayer.addLayer(m);
                count++;
                if (isTarget) { map.setView(m.getLatLng(), 12); m.openPopup(); }
            }
        });
        document.getElementById("stat").innerHTML = `–ù–∏–π—Ç: ${count}`;
    }

    [aimagSelect, orgSelect].forEach(el => el.onchange = render);
    nameSearch.oninput = render;
    render();
</script>
</body>
</html>